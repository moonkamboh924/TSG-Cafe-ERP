{% extends "base.html" %}

{% block title %}User Management - {{ get_setting('restaurant_name', 'ERP') }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <div class="container mx-auto px-4 py-6">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">User Management</h1>
                <p class="text-gray-600 mt-2">Manage system users, roles, and permissions</p>
            </div>
            <div class="flex space-x-3">
                <button id="addUserBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-user-plus mr-2"></i>Add User
                </button>
            </div>
        </div>

        <!-- System Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Users</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalUsers">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Sessions</p>
                        <p class="text-3xl font-bold text-green-600" id="activeSessions">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">System Health</p>
                        <p class="text-lg font-bold text-green-600" id="systemHealth">Excellent</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-heartbeat text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Database Size</p>
                        <p class="text-xl font-bold text-purple-600" id="databaseSize">0 MB</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-database text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">User Management</h2>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="usersContent" class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
            <!-- User Filters -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="roleFilter" title="Filter users by role" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Roles</option>
                        {% if current_user.role == 'system_administrator' %}
                        <option value="system_administrator">System Administrator</option>
                        {% endif %}
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="employee">Employee</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="statusFilter" title="Filter users by status" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Status</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" id="userSearchInput" title="Search users by name, email, or employee ID" placeholder="Search users..." class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex items-end">
                    <button id="resetUserFilters" class="w-full bg-gray-500 text-white px-4 py-2 rounded-xl hover:bg-gray-600 transition-colors">
                        Reset Filters
                    </button>
                </div>
            </div>

            <!-- Users Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">User</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Email</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Role</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Navigation Permissions</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>


    </div>
</div>

<!-- Delete User Confirmation Modal -->
<div id="deleteUserModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Delete User</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this user? This action cannot be undone.</p>
            
            <div id="deleteUserInfo" class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800" id="deleteUserName">User Name</p>
                        <p class="text-sm text-gray-600" id="deleteUserRole">Role</p>
                        <p class="text-sm text-gray-600" id="deleteUserEmail">email@example.com</p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button id="cancelDeleteUser" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button id="confirmDeleteUser" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-8 max-w-2xl mx-4 shadow-2xl w-full">
        <div class="flex items-center justify-between mb-6">
            <h3 id="userModalTitle" class="text-2xl font-bold text-gray-800">Add User</h3>
            <button id="closeUserModal" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
        </div>
        
        <form id="userForm" class="space-y-4 max-h-96 overflow-y-auto">
            <input type="hidden" id="userId">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                    <input type="text" id="userFirstName" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                    <input type="text" id="userLastName" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="userEmail" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <input type="text" id="userDepartment" title="Enter user's department" placeholder="e.g., Kitchen, Service, Management" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Designation</label>
                    <input type="text" id="userDesignation" title="Enter user's job designation" placeholder="e.g., Chef, Waiter, Manager" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                    <input type="tel" id="userPhone" title="Enter user's phone number" placeholder="e.g., +92 300 1234567" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="userUsername" readonly class="w-full px-4 py-2 border border-gray-200 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed">
                    <p class="text-xs text-gray-500 mt-1">Auto-generated from first name + last name + employee ID</p>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                <textarea id="userAddress" rows="2" title="Enter user's address" placeholder="Enter complete address" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
                <div class="flex items-center space-x-4">
                    <div id="profilePreview" class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user text-gray-400 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <input type="file" id="profilePicture" accept="image/*" class="hidden" onchange="handleProfilePictureChange(this)">
                        <button type="button" onclick="document.getElementById('profilePicture').click()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            Choose Picture
                        </button>
                        <p class="text-xs text-gray-500 mt-1">PNG, JPG, JPEG, GIF (Max 2MB)</p>
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                <select id="userRole" title="Select user's role" required class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Role</option>
                    {% if current_user.role == 'system_administrator' %}
                    <option value="system_administrator">System Administrator</option>
                    {% endif %}
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                    <option value="employee">Employee</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Navigation Permissions</label>
                <div id="navigationPermissions" class="grid grid-cols-2 gap-2 p-3 border border-gray-200 rounded-xl max-h-32 overflow-y-auto">
                    <!-- Navigation permissions will be loaded here -->
                </div>
                <p class="text-xs text-gray-500 mt-1">Select which sections this user can access</p>
            </div>
            
            <div id="passwordSection">
                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" id="userPassword" title="Enter user password" placeholder="Leave blank for auto-generated password" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="text-xs text-gray-500 mt-1">Leave blank for auto-generated password (new user) or to keep current (edit mode)</p>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <input type="checkbox" id="userActive" title="Set user as active or inactive" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="userActive" class="ml-2 text-sm text-gray-700">Active</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="userRequirePasswordChange" title="Require user to change password on next login" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="userRequirePasswordChange" class="ml-2 text-sm text-gray-700">Require Password Change</label>
                </div>
            </div>
            
            <div class="flex space-x-3 pt-4">
                <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-300">
                    Save User
                </button>
                <button type="button" id="cancelUserBtn" class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-semibold hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let users = [];
let auditLogs = [];

document.addEventListener('DOMContentLoaded', function() {
    loadSystemStats();
    loadUsers();
    loadNavigationPermissions();
    
    // Modal events
    document.getElementById('addUserBtn').addEventListener('click', () => openUserModal());
    document.getElementById('closeUserModal').addEventListener('click', closeUserModal);
    document.getElementById('cancelUserBtn').addEventListener('click', closeUserModal);
    document.getElementById('userForm').addEventListener('submit', saveUser);
    
    // Delete user modal event listeners
    document.getElementById('cancelDeleteUser').addEventListener('click', closeDeleteUserModal);
    document.getElementById('confirmDeleteUser').addEventListener('click', confirmUserDeletion);
    
    // Filter events
    document.getElementById('roleFilter').addEventListener('change', loadUsers);
    document.getElementById('statusFilter').addEventListener('change', loadUsers);
    document.getElementById('userSearchInput').addEventListener('input', debounce(loadUsers, 300));
    document.getElementById('resetUserFilters').addEventListener('click', resetUserFilters);
    
    // Username auto-generation
    document.getElementById('userFirstName').addEventListener('input', generateUsername);
    document.getElementById('userLastName').addEventListener('input', generateUsername);
});

async function loadSystemStats() {
    try {
        const response = await fetch('/admin/api/stats');
        const data = await response.json();
        
        document.getElementById('totalUsers').textContent = data.total_users || 0;
        document.getElementById('activeSessions').textContent = data.active_sessions || 0;
        document.getElementById('systemHealth').textContent = data.system_health || 'Good';
        document.getElementById('databaseSize').textContent = `${data.database_size || 0} MB`;
    } catch (error) {
        console.error('Error loading system stats:', error);
    }
}

async function loadUsers() {
    try {
        const role = document.getElementById('roleFilter').value;
        const status = document.getElementById('statusFilter').value;
        const search = document.getElementById('userSearchInput').value;
        
        let url = '/admin/api/users';
        const params = new URLSearchParams();
        if (role) params.append('role', role);
        if (status) params.append('is_active', status);
        if (search) params.append('search', search);
        
        if (params.toString()) url += '?' + params.toString();
        
        const response = await fetch(url);
        const data = await response.json();
        users = data.users;
        
        renderUsersTable();
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

function renderUsersTable() {
    const tbody = document.getElementById('usersTableBody');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No users found</td></tr>';
        return;
    }
    
    tbody.innerHTML = users.map(user => {
        const navPerms = user.navigation_permissions || [];
        const permissionLabels = {
            'dashboard': 'Dashboard',
            'pos': 'POS',
            'menu': 'Menu',
            'inventory': 'Inventory',
            'employee': 'Employee',
            'finance': 'Finance',
            'reports': 'Reports',
            'admin': 'Admin'
        };
        const navPermText = navPerms.length > 0 ? 
            navPerms.map(perm => permissionLabels[perm] || perm).join(', ') : 
            'No permissions';
        
        return `
        <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="py-3 px-4">
                <div>
                    <p class="font-semibold text-gray-800">${user.full_name}</p>
                    <p class="text-sm text-gray-500">@${user.username}</p>
                </div>
            </td>
            <td class="py-3 px-4 text-gray-600">${user.email}</td>
            <td class="py-3 px-4">
                <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 capitalize">
                    ${user.role}
                </span>
            </td>
            <td class="py-3 px-4">
                <span class="px-3 py-1 rounded-full text-xs font-medium ${user.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td class="py-3 px-4">
                <div class="text-xs text-gray-600 max-w-xs">
                    ${navPermText}
                </div>
            </td>
            <td class="py-3 px-4">
                <div class="flex space-x-2">
                    <button onclick="editUser(${user.id})" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                        Edit
                    </button>
                    <button onclick="deleteUser(${user.id})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition-colors text-sm">
                        Delete
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
}


async function loadNavigationPermissions() {
    try {
        const response = await fetch('/admin/api/navigation-permissions');
        const data = await response.json();
        window.navigationPermissions = data.permissions;
        console.log('Navigation permissions loaded:', window.navigationPermissions);
    } catch (error) {
        console.error('Error loading navigation permissions:', error);
        window.navigationPermissions = [];
    }
}

function renderNavigationPermissions(selectedPermissions = []) {
    const container = document.getElementById('navigationPermissions');
    console.log('Rendering navigation permissions:', window.navigationPermissions, 'Selected:', selectedPermissions);
    
    if (!window.navigationPermissions || window.navigationPermissions.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">No navigation permissions available</p>';
        return;
    }
    
    container.innerHTML = window.navigationPermissions.map(perm => `
        <div class="flex items-center">
            <input type="checkbox" id="nav_${perm.value}" value="${perm.value}" 
                   ${selectedPermissions.includes(perm.value) ? 'checked' : ''}
                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <label for="nav_${perm.value}" class="ml-2 text-sm text-gray-700">${perm.label}</label>
        </div>
    `).join('');
}

function getSelectedNavigationPermissions() {
    const checkboxes = document.querySelectorAll('#navigationPermissions input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function generateUsername() {
    const firstName = document.getElementById('userFirstName').value.trim();
    const lastName = document.getElementById('userLastName').value.trim();
    
    if (firstName && lastName) {
        // Get next employee ID for username generation
        fetch('/admin/api/next-employee-id')
            .then(response => response.json())
            .then(data => {
                const empId = data.employee_id;
                const firstChar = firstName[0].toUpperCase();
                const lastChar = lastName[0].toUpperCase();
                const empNum = empId.substring(3); // Remove 'EMP' prefix
                const username = `${firstChar}${lastChar}${empNum}`;
                document.getElementById('userUsername').value = username;
            })
            .catch(error => {
                console.error('Error generating username:', error);
            });
    } else {
        document.getElementById('userUsername').value = '';
    }
}

function openUserModal(user = null) {
    const modal = document.getElementById('userModal');
    const title = document.getElementById('userModalTitle');
    
    // Ensure navigation permissions are loaded before opening modal
    if (!window.navigationPermissions) {
        loadNavigationPermissions().then(() => {
            openUserModalWithData(user, modal, title);
        });
    } else {
        openUserModalWithData(user, modal, title);
    }
}

function openUserModalWithData(user, modal, title) {
    // First render navigation permissions
    if (user) {
        title.textContent = 'Edit User';
        document.getElementById('userId').value = user.id;
        document.getElementById('userFirstName').value = user.first_name || '';
        document.getElementById('userLastName').value = user.last_name || '';
        document.getElementById('userUsername').value = user.username || '';
        document.getElementById('userEmail').value = user.email || '';
        document.getElementById('userRole').value = user.role || 'employee';
        document.getElementById('userDepartment').value = user.department || '';
        document.getElementById('userDesignation').value = user.designation || '';
        document.getElementById('userPhone').value = user.phone || '';
        document.getElementById('userAddress').value = user.address || '';
        
        // Render navigation permissions with user's current permissions
        const userPermissions = user.navigation_permissions || [];
        renderNavigationPermissions(userPermissions);
    } else {
        title.textContent = 'Add User';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        
        // Render navigation permissions with no selections
        renderNavigationPermissions([]);
    }
    
    // Add event listeners for username generation (only for new users)
    if (!user) {
        const firstNameField = document.getElementById('userFirstName');
        const lastNameField = document.getElementById('userLastName');
        
        // Remove existing listeners to avoid duplicates
        firstNameField.removeEventListener('input', generateUsername);
        lastNameField.removeEventListener('input', generateUsername);
        
        // Add new listeners
        firstNameField.addEventListener('input', generateUsername);
        lastNameField.addEventListener('input', generateUsername);
    }
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeUserModal() {
    const modal = document.getElementById('userModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

async function saveUser(event) {
    event.preventDefault();
    
    const userId = document.getElementById('userId').value;
    const isEdit = !!userId;
    
    const data = {
        first_name: document.getElementById('userFirstName').value,
        last_name: document.getElementById('userLastName').value,
        email: document.getElementById('userEmail').value,
        username: document.getElementById('userUsername').value,
        department: document.getElementById('userDepartment').value,
        designation: document.getElementById('userDesignation').value,
        phone: document.getElementById('userPhone').value,
        address: document.getElementById('userAddress').value,
        role: document.getElementById('userRole').value,
        navigation_permissions: JSON.stringify(getSelectedNavigationPermissions()),
        requires_password_change: document.getElementById('userRequirePasswordChange').checked,
        is_active: document.getElementById('userActive').checked
    };
    
    const password = document.getElementById('userPassword').value;
    if (password) {
        data.password = password;
    }
    // Don't include password field if empty - let server use default
    
    try {
        const url = isEdit ? `/admin/api/users/${userId}` : '/admin/api/users';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Upload profile picture if selected
            const actualUserId = result.user_id || userId;
            if (actualUserId) {
                await uploadProfilePicture(actualUserId);
            }
            
            showNotification(isEdit ? 'User updated successfully' : 'User created successfully', 'success');
            closeUserModal();
            loadUsers();
        } else {
            showNotification(result.error || 'Failed to save user', 'error');
        }
    } catch (error) {
        console.error('Error saving user:', error);
        showNotification('An error occurred while saving user', 'error');
    }
}

async function editUser(userId) {
    const user = users.find(u => u.id === userId);
    if (user) {
        openUserModal(user);
    }
}

let userToDelete = null;

async function deleteUser(userId) {
    try {
        // Get user details first
        const response = await fetch(`/admin/api/users/${userId}`);
        if (response.ok) {
            const user = await response.json();
            userToDelete = user;
            
            // Populate modal with user details
            document.getElementById('deleteUserName').textContent = user.full_name || `${user.first_name} ${user.last_name}`;
            document.getElementById('deleteUserRole').textContent = user.role;
            document.getElementById('deleteUserEmail').textContent = user.email;
            
            // Show delete confirmation modal
            document.getElementById('deleteUserModal').classList.remove('hidden');
            document.getElementById('deleteUserModal').classList.add('flex');
        } else {
            showNotification('Failed to load user details', 'error');
        }
    } catch (error) {
        console.error('Error loading user details:', error);
        showNotification('An error occurred while loading user details', 'error');
    }
}

async function confirmUserDeletion() {
    if (!userToDelete) return;
    
    try {
        const response = await fetch(`/admin/api/users/${userToDelete.id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadUsers();
            loadSystemStats();
            showNotification('User deleted successfully', 'success');
            closeDeleteUserModal();
        } else {
            const result = await response.json();
            showNotification(result.error || 'Failed to delete user', 'error');
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        showNotification('An error occurred while deleting', 'error');
    }
}

function closeDeleteUserModal() {
    document.getElementById('deleteUserModal').classList.add('hidden');
    document.getElementById('deleteUserModal').classList.remove('flex');
    userToDelete = null;
}

async function saveSettings() {
    const settings = {
        business_name: document.getElementById('businessName').value,
        currency: document.getElementById('currency').value,
        tax_rate: parseFloat(document.getElementById('taxRate').value) / 100,
        timezone: document.getElementById('timezone').value,
        session_timeout: parseInt(document.getElementById('sessionTimeout').value),
        password_min_length: parseInt(document.getElementById('passwordMinLength').value),
        require_password_complexity: document.getElementById('requirePasswordComplexity').checked,
        enable_two_factor: document.getElementById('enableTwoFactor').checked
    };
    
    try {
        const response = await fetch('/admin/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification('Settings saved successfully', 'success');
        } else {
            showNotification(result.error || 'Failed to save settings', 'error');
        }
    } catch (error) {
        console.error('Error saving settings:', error);
        showNotification('An error occurred while saving settings', 'error');
    }
}

function resetUserFilters() {
    document.getElementById('roleFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('userSearchInput').value = '';
    loadUsers();
}

function showNotification(message, type = 'info') {
    const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 bg-${color}-500 text-white px-6 py-3 rounded-xl shadow-lg z-50`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function handleProfilePictureChange(input) {
    const file = input.files[0];
    if (file) {
        // Validate file size (2MB max)
        if (file.size > 2 * 1024 * 1024) {
            showNotification('File size must be less than 2MB', 'error');
            input.value = '';
            return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profilePreview');
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover rounded-full">`;
        };
        reader.readAsDataURL(file);
    }
}

async function uploadProfilePicture(userId) {
    const fileInput = document.getElementById('profilePicture');
    const file = fileInput.files[0];
    
    if (!file) return null;
    
    const formData = new FormData();
    formData.append('profile_picture', file);
    formData.append('user_id', userId);
    
    try {
        const response = await fetch('/admin/api/upload-profile-picture', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            return result.filename;
        } else {
            showNotification(result.error || 'Failed to upload profile picture', 'error');
            return null;
        }
    } catch (error) {
        console.error('Error uploading profile picture:', error);
        showNotification('An error occurred while uploading profile picture', 'error');
        return null;
    }
}

// Load navigation permissions when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadNavigationPermissions();
    loadUsers();
});
</script>
{% endblock %}
