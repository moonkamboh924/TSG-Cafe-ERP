{% extends "base.html" %}

{% block title %}Reports & Analytics - {{ get_setting('restaurant_name', 'ERP') }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <div class="container mx-auto px-4 py-6">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Reports & Analytics</h1>
                <p class="text-gray-600 mt-2">Comprehensive business insights and data analysis</p>
            </div>
            <div class="flex space-x-3">
                <button id="exportSalesBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-download mr-2"></i>Export Sales
                </button>
                <button id="exportExpensesBtn" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-download mr-2"></i>Export Expenses
                </button>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                    <input type="date" id="dateFrom" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                    <input type="date" id="dateTo" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quick Select</label>
                    <select id="quickDateSelect" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Custom Range</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="this_week">This Week</option>
                        <option value="last_week">Last Week</option>
                        <option value="this_month">This Month</option>
                        <option value="last_month">Last Month</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="applyFilters" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Sales Trend Chart -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Sales Trend</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">Total:</span>
                        <span class="text-lg font-bold text-green-600" id="salesTrendTotal">₨0.00</span>
                    </div>
                </div>
                <div class="relative h-80">
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>

            <!-- Top Items Chart -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Top Selling Items</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">Revenue:</span>
                        <span class="text-lg font-bold text-blue-600" id="topItemsRevenue">₨0.00</span>
                    </div>
                </div>
                <div class="relative h-80">
                    <canvas id="topItemsChart"></canvas>
                </div>
            </div>

            <!-- Expense Categories Chart -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Expense Categories</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">Total:</span>
                        <span class="text-lg font-bold text-red-600" id="expenseCategoriesTotal">₨0.00</span>
                    </div>
                </div>
                <div class="relative h-80">
                    <canvas id="expenseCategoriesChart"></canvas>
                </div>
            </div>

            <!-- Revenue vs Expenses Chart -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Revenue vs Expenses</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-sm text-gray-500">Revenue</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-sm text-gray-500">Expenses</span>
                        </div>
                    </div>
                </div>
                <div class="relative h-80">
                    <canvas id="revenueExpensesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Sales Summary Table -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Sales Summary</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Date</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Orders</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Revenue</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Avg Order</th>
                            </tr>
                        </thead>
                        <tbody id="salesSummaryBody">
                            <!-- Sales summary will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Items Table -->
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Top Selling Items</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Item</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Category</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Qty Sold</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="topItemsBody">
                            <!-- Top items will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Reports Section -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-800">Inventory Reports</h2>
        <div class="flex space-x-3">
            <select id="inventoryCategory" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" title="Filter by category">
                <option value="">All Categories</option>
            </select>
            <label class="flex items-center">
                <input type="checkbox" id="lowStockOnly" class="mr-2" title="Show only low stock items">
                <span class="text-sm text-gray-600">Low Stock Only</span>
            </label>
            <button onclick="loadInventoryReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                Refresh
            </button>
            <button onclick="exportInventory()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                Export Inventory CSV
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-blue-600 mb-1">Total Items</h3>
            <p class="text-2xl font-bold text-blue-800" id="totalItems">0</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-green-600 mb-1">Total Value</h3>
            <p class="text-2xl font-bold text-green-800" id="totalInventoryValue">₨0</p>
        </div>
        <div class="bg-red-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-red-600 mb-1">Low Stock Items</h3>
            <p class="text-2xl font-bold text-red-800" id="lowStockItems">0</p>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
            <thead class="bg-gray-50">
                <tr>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min Stock</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Cost</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Inventory items will be loaded here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let salesTrendChart, topItemsChart, expenseCategoriesChart, revenueExpensesChart;

document.addEventListener('DOMContentLoaded', function() {
    // Set default date range (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
    
    // Load initial data
    loadAllReports();
    
    // Event listeners
    document.getElementById('applyFilters').addEventListener('click', loadAllReports);
    document.getElementById('quickDateSelect').addEventListener('change', handleQuickDateSelect);
    document.getElementById('exportSalesBtn').addEventListener('click', exportSales);
    document.getElementById('exportExpensesBtn').addEventListener('click', exportExpenses);
});

function handleQuickDateSelect() {
    const select = document.getElementById('quickDateSelect');
    const value = select.value;
    const today = new Date();
    let fromDate, toDate;
    
    switch(value) {
        case 'today':
            fromDate = toDate = today;
            break;
        case 'yesterday':
            fromDate = toDate = new Date(today.getTime() - (24 * 60 * 60 * 1000));
            break;
        case 'this_week':
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
            fromDate = startOfWeek;
            toDate = new Date();
            break;
        case 'last_week':
            const lastWeekStart = new Date(today.setDate(today.getDate() - today.getDay() - 7));
            const lastWeekEnd = new Date(today.setDate(today.getDate() - today.getDay() - 1));
            fromDate = lastWeekStart;
            toDate = lastWeekEnd;
            break;
        case 'this_month':
            fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
            toDate = new Date();
            break;
        case 'last_month':
            fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            toDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        default:
            return;
    }
    
    document.getElementById('dateFrom').value = fromDate.toISOString().split('T')[0];
    document.getElementById('dateTo').value = toDate.toISOString().split('T')[0];
    
    loadAllReports();
}

async function loadAllReports() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    const promises = [
        loadSalesTrend(dateFrom, dateTo),
        loadTopItems(dateFrom, dateTo),
        loadExpenseCategories(dateFrom, dateTo),
        loadRevenueExpenses(dateFrom, dateTo),
        loadSalesSummary(dateFrom, dateTo)
    ];
    
    // Only load inventory reports if elements exist
    if (document.getElementById('inventoryCategory')) {
        promises.push(loadInventoryCategories());
        promises.push(loadInventoryReport());
    }
    
    await Promise.all(promises);
}

async function loadSalesTrend(dateFrom, dateTo) {
    try {
        const params = new URLSearchParams();
        if (dateFrom) params.append('start_date', dateFrom);
        if (dateTo) params.append('end_date', dateTo);
        params.append('group_by', 'day');
        
        const url = `/reports/api/sales?${params.toString()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && Array.isArray(result.data)) {
            updateSalesTrendChart(result.data);
        } else {
            updateSalesTrendChart([]);
        }
    } catch (error) {
        console.error('Error loading sales trend:', error);
        updateSalesTrendChart([]);
    }
}

async function loadTopItems(dateFrom, dateTo) {
    try {
        let url = '/reports/api/top-items';
        if (dateFrom && dateTo) {
            url += `?start_date=${dateFrom}&end_date=${dateTo}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (!result.success) {
            console.error('Error in top items response:', result.error);
            return;
        }
        
        const data = result.data;
        
        const totalRevenue = data.reduce((sum, item) => sum + parseFloat(item.total_revenue), 0);
        document.getElementById('topItemsRevenue').textContent = `₨${totalRevenue.toFixed(2)}`;
        
        // Update chart
        if (topItemsChart) {
            topItemsChart.destroy();
        }
        
        const ctx = document.getElementById('topItemsChart').getContext('2d');
        const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316'];
        
        topItemsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.slice(0, 8).map(item => item.item_name),
                datasets: [{
                    data: data.slice(0, 8).map(item => parseFloat(item.total_revenue)),
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
        
        // Update table
        const tbody = document.getElementById('topItemsBody');
        tbody.innerHTML = data.slice(0, 10).map(item => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-4 font-semibold text-gray-800">${item.item_name}</td>
                <td class="py-3 px-4 text-gray-600">${item.category}</td>
                <td class="py-3 px-4 text-gray-600">${parseFloat(item.total_qty).toFixed(0)}</td>
                <td class="py-3 px-4 font-semibold text-green-600">₨${parseFloat(item.total_revenue).toFixed(2)}</td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading top items:', error);
    }
}

async function loadExpenseCategories(dateFrom, dateTo) {
    try {
        let url = '/reports/api/expenses?group_by=category';
        if (dateFrom && dateTo) {
            url += `&start_date=${dateFrom}&end_date=${dateTo}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (!result.success || !Array.isArray(result.data)) {
            console.warn('No expense categories data available');
            document.getElementById('expenseCategoriesTotal').textContent = '₨0.00';
            return;
        }
        
        const data = result.data;
        
        // Calculate total
        const total = data.reduce((sum, item) => sum + parseFloat(item.total_amount), 0);
        document.getElementById('expenseCategoriesTotal').textContent = `₨${total.toFixed(2)}`;
        
        // Update chart
        if (expenseCategoriesChart) {
            expenseCategoriesChart.destroy();
        }
        
        const ctx = document.getElementById('expenseCategoriesChart').getContext('2d');
        const colors = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#06B6D4'];
        
        expenseCategoriesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.label),
                datasets: [{
                    label: 'Expenses',
                    data: data.map(item => parseFloat(item.total_amount)),
                    backgroundColor: colors,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₨' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading expense categories:', error);
    }
}

async function loadRevenueExpenses(dateFrom, dateTo) {
    try {
        const [salesResponse, expensesResponse] = await Promise.all([
            fetch(`/reports/api/sales${dateFrom && dateTo ? `?start_date=${dateFrom}&end_date=${dateTo}` : ''}`),
            fetch(`/reports/api/expenses?group_by=date${dateFrom && dateTo ? `&start_date=${dateFrom}&end_date=${dateTo}` : ''}`)
        ]);
        
        const salesResult = await salesResponse.json();
        const expensesResult = await expensesResponse.json();
        
        if (!salesResult.success || !expensesResult.success) {
            console.error('Error in revenue/expenses response');
            return;
        }
        
        const salesData = salesResult.data;
        const expensesData = expensesResult.data;
        
        // Create date-aligned datasets
        const dates = [...new Set([
            ...salesData.map(item => item.date),
            ...expensesData.map(item => item.label)
        ])].sort();
        
        const revenueByDate = {};
        const expensesByDate = {};
        
        salesData.forEach(item => {
            revenueByDate[item.date] = parseFloat(item.total_sales);
        });
        
        expensesData.forEach(item => {
            expensesByDate[item.label] = parseFloat(item.total_amount);
        });
        
        // Update chart
        if (revenueExpensesChart) {
            revenueExpensesChart.destroy();
        }
        
        const ctx = document.getElementById('revenueExpensesChart').getContext('2d');
        revenueExpensesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates.map(date => new Date(date).toLocaleDateString()),
                datasets: [{
                    label: 'Revenue',
                    data: dates.map(date => revenueByDate[date] || 0),
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Expenses',
                    data: dates.map(date => expensesByDate[date] || 0),
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₨' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading revenue vs expenses:', error);
    }
}

async function loadSalesSummary(dateFrom, dateTo) {
    try {
        let url = '/reports/api/sales';
        if (dateFrom && dateTo) {
            url += `?start_date=${dateFrom}&end_date=${dateTo}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        const data = result.success ? result.data : [];
        
        const tbody = document.getElementById('salesSummaryBody');
        if (tbody) {
            tbody.innerHTML = data.map(item => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 font-semibold text-gray-800">${new Date(item.date).toLocaleDateString()}</td>
                    <td class="py-3 px-4 text-gray-600">${item.order_count}</td>
                    <td class="py-3 px-4 font-semibold text-green-600">₨${parseFloat(item.total_sales).toFixed(2)}</td>
                    <td class="py-3 px-4 text-gray-600">₨${parseFloat(item.avg_order_value).toFixed(2)}</td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading sales summary:', error);
    }
}

function updateSalesTrendChart(data) {
    try {
        if (salesTrendChart) {
            salesTrendChart.destroy();
        }
        
        if (!data || data.length === 0) {
            document.getElementById('salesTrendTotal').textContent = '0 Orders • ₨0.00 Total • ₨0.00 Revenue';
            return;
        }
        
        const totalOrders = data.reduce((sum, item) => sum + parseInt(item.order_count), 0);
        const totalRevenue = data.reduce((sum, item) => sum + parseFloat(item.total_sales), 0);
        const totalOrderValue = data.reduce((sum, item) => sum + parseFloat(item.total_order_value || 0), 0);
        
        document.getElementById('salesTrendTotal').textContent = `${totalOrders} Orders • ₨${totalOrderValue.toFixed(2)} Total • ₨${totalRevenue.toFixed(2)} Revenue`;
        
        const ctx = document.getElementById('salesTrendChart').getContext('2d');
        salesTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(item => new Date(item.date).toLocaleDateString()),
                datasets: [{
                    label: 'Orders',
                    data: data.map(item => parseInt(item.order_count)),
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: 'Revenue',
                    data: data.map(item => parseFloat(item.total_sales)),
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return value + ' Orders';
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₨' + value.toLocaleString();
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error updating sales trend chart:', error);
    }
}

function updateSalesSummary(data) {
    // This function is called by loadSalesSummary, so we don't need to duplicate the logic
}

async function exportSales() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    let url = '/reports/api/export/sales';
    if (dateFrom && dateTo) {
        url += `?start_date=${dateFrom}&end_date=${dateTo}`;
    }
    
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `sales_report_${dateFrom || 'all'}_to_${dateTo || 'all'}.csv`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(downloadUrl);
        
        showNotification('Sales report exported successfully', 'success');
    } catch (error) {
        console.error('Error exporting sales:', error);
        showNotification('Failed to export sales report', 'error');
    }
}

async function exportExpenses() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    let url = '/reports/api/export/expenses';
    if (dateFrom && dateTo) {
        url += `?start_date=${dateFrom}&end_date=${dateTo}`;
    }
    
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `expenses_report_${dateFrom || 'all'}_to_${dateTo || 'all'}.csv`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(downloadUrl);
        
        showNotification('Expenses report exported successfully', 'success');
    } catch (error) {
        console.error('Error exporting expenses:', error);
        showNotification('Failed to export expenses report', 'error');
    }
}

// Inventory Reports Functions
async function loadInventoryCategories() {
    try {
        const response = await fetch('/inventory/api/categories');
        const result = await response.json();
        
        if (result.success) {
            const select = document.getElementById('inventoryCategory');
            select.innerHTML = '<option value="">All Categories</option>';
            result.categories.forEach(category => {
                select.innerHTML += `<option value="${category}">${category}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading inventory categories:', error);
    }
}

async function loadInventoryReport() {
    try {
        const category = document.getElementById('inventoryCategory').value;
        const lowStockOnly = document.getElementById('lowStockOnly').checked;
        
        const params = new URLSearchParams();
        if (category) params.append('category', category);
        if (lowStockOnly) params.append('low_stock_only', 'true');
        
        const response = await fetch(`/reports/api/inventory?${params}`);
        const result = await response.json();
        
        if (result.success) {
            // Update summary cards
            document.getElementById('totalItems').textContent = result.summary.total_items;
            document.getElementById('totalInventoryValue').textContent = `₨${result.summary.total_value.toFixed(2)}`;
            document.getElementById('lowStockItems').textContent = result.summary.low_stock_items;
            
            // Update table
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = result.items.map(item => {
                const totalValue = parseFloat(item.current_stock) * parseFloat(item.unit_cost);
                const isLowStock = parseFloat(item.current_stock) <= parseFloat(item.min_stock_level);
                const statusClass = isLowStock ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
                const statusText = isLowStock ? 'Low Stock' : 'Normal';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="py-3 px-4 text-sm font-medium text-gray-900">${item.sku}</td>
                        <td class="py-3 px-4 text-sm text-gray-900">${item.name}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${item.category}</td>
                        <td class="py-3 px-4 text-sm text-gray-900">${parseFloat(item.current_stock).toFixed(2)} ${item.unit}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${parseFloat(item.min_stock_level).toFixed(2)} ${item.unit}</td>
                        <td class="py-3 px-4 text-sm text-gray-900">₨${parseFloat(item.unit_cost).toFixed(2)}</td>
                        <td class="py-3 px-4 text-sm font-semibold text-green-600">₨${totalValue.toFixed(2)}</td>
                        <td class="py-3 px-4">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading inventory report:', error);
    }
}

async function exportInventory() {
    const category = document.getElementById('inventoryCategory').value;
    const lowStockOnly = document.getElementById('lowStockOnly').checked;
    
    const params = new URLSearchParams();
    if (category) params.append('category', category);
    if (lowStockOnly) params.append('low_stock_only', 'true');
    
    try {
        const response = await fetch(`/reports/api/export/inventory?${params}`);
        const blob = await response.blob();
        
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `inventory_report_${category || 'all'}_${lowStockOnly ? 'low_stock' : 'all'}.csv`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(downloadUrl);
        
        showNotification('Inventory report exported successfully', 'success');
    } catch (error) {
        console.error('Error exporting inventory:', error);
        showNotification('Failed to export inventory report', 'error');
    }
}

function showNotification(message, type = 'info') {
    const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 bg-${color}-500 text-white px-6 py-3 rounded-xl shadow-lg z-50`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Event listeners for inventory filters
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('inventoryCategory')) {
        document.getElementById('inventoryCategory').addEventListener('change', loadInventoryReport);
    }
    if (document.getElementById('lowStockOnly')) {
        document.getElementById('lowStockOnly').addEventListener('change', loadInventoryReport);
    }
});
</script>
{% endblock %}
