{% extends "system_admin/base.html" %}

{% block title %}System Dashboard - TSG ERP{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
    <!-- Main Dashboard Grid -->
    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Top Row - Profile & Activity -->
        <div class="grid grid-cols-1 xl:grid-cols-5 gap-8 mb-8">
            <!-- Employee Details - Enhanced Luxury Design -->
            <div class="xl:col-span-2">
                <div class="luxury-card h-full">
                    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 backdrop-blur-xl border border-white/20 shadow-2xl h-full flex flex-col">
                        <!-- Decorative Elements -->
                        <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-400/8 to-indigo-500/8 rounded-full -translate-y-20 translate-x-20"></div>
                        <div class="absolute bottom-0 left-0 w-32 h-32 bg-gradient-to-tr from-purple-400/8 to-pink-500/8 rounded-full translate-y-16 -translate-x-16"></div>
                        
                        <div class="relative">
                            <!-- Header Section -->
                            <div class="flex items-center justify-between p-8 pb-4">
                                <div class="flex items-center">
                                    <div class="w-14 h-14 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center mr-4 shadow-xl">
                                        <i class="fas fa-user-tie text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold bg-gradient-to-r from-gray-800 via-blue-700 to-indigo-800 bg-clip-text text-transparent">
                                            Employee Details
                                        </h3>
                                        <p class="text-gray-600 text-sm font-medium">Profile information</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative px-8 pb-8 flex-1 flex flex-col justify-between">
                            <!-- Employee Photo Section -->
                            <div class="text-center mb-4">
                                <div class="relative inline-block">
                                    <!-- Employee Picture -->
                                    <div class="relative w-24 h-24 bg-gradient-to-br from-blue-500 via-indigo-600 to-purple-600 rounded-full flex items-center justify-center shadow-2xl mb-4 mx-auto overflow-hidden border-4 border-white group">
                                        {% if current_user.profile_picture %}
                                            <img src="{{ current_user.profile_picture }}" alt="{{ current_user.username }}" class="w-full h-full object-cover">
                                        {% else %}
                                            <i class="fas fa-user text-white text-3xl"></i>
                                        {% endif %}
                                        
                                        <!-- Upload Button Overlay -->
                                        <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 cursor-pointer" onclick="document.getElementById('profilePictureInput').click()">
                                            <i class="fas fa-camera text-white text-lg"></i>
                                        </div>
                                        
                                        <!-- Hidden File Input -->
                                        <input type="file" id="profilePictureInput" accept="image/*" class="hidden" onchange="uploadProfilePicture(this)" aria-label="Upload profile picture" title="Upload profile picture">
                                    </div>
                                </div>
                                <!-- Employee Name -->
                                <h3 class="text-xl font-bold text-gray-800 mb-1">{{ current_user.full_name or current_user.username }}</h3>
                                <!-- Employee Designation (NOT Role) -->
                                <p class="text-indigo-600 font-semibold text-base mb-1">
                                    {{ current_user.designation or 'No Designation Set' }}
                                </p>
                                <div class="w-12 h-1 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full mx-auto"></div>
                            </div>
                            
                            <!-- Employee Details Table -->
                            <div class="bg-white/60 rounded-2xl p-4 backdrop-blur-sm border border-white/40 shadow-lg flex-1">
                                
                                <div class="space-y-3">
                                    <!-- Employee ID -->
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-6 h-6 bg-blue-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-hashtag text-blue-600 text-xs"></i>
                                            </div>
                                            <span class="font-medium text-gray-700 text-sm">Employee ID</span>
                                        </div>
                                        <span class="text-gray-800 font-semibold text-sm">{{ current_user.employee_id }}</span>
                                    </div>
                                    
                                    <!-- Department -->
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-6 h-6 bg-purple-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-building text-purple-600 text-xs"></i>
                                            </div>
                                            <span class="font-medium text-gray-700 text-sm">Department</span>
                                        </div>
                                        <span class="text-gray-800 font-semibold text-sm">{{ current_user.department or 'Management' }}</span>
                                    </div>
                                    
                                    <!-- Contact Number -->
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-6 h-6 bg-green-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-phone text-green-600 text-xs"></i>
                                            </div>
                                            <span class="font-medium text-gray-700 text-sm">Contact</span>
                                        </div>
                                        <span class="text-gray-800 font-semibold text-sm">{{ current_user.phone or '+92 300 1234567' }}</span>
                                    </div>
                                    
                                    <!-- Address -->
                                    <div class="flex items-center justify-between py-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-6 h-6 bg-orange-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-map-marker-alt text-orange-600 text-xs"></i>
                                            </div>
                                            <span class="font-medium text-gray-700 text-sm">Address</span>
                                        </div>
                                        <span class="text-gray-800 font-semibold text-sm text-right max-w-xs">{{ current_user.address or 'Lahore, Punjab, Pakistan' }}</span>
                                    </div>
                                    
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Today Performance - Enhanced Layout -->
            <div class="xl:col-span-3">
                <!-- Today's Performance - Professional Square Design -->
                <div class="relative overflow-hidden bg-gradient-to-br from-white via-slate-50/60 to-blue-50/40 rounded-3xl p-8 backdrop-blur-xl border border-white/30 shadow-2xl">
                    <!-- Decorative Elements -->
                    <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-blue-400/8 to-indigo-500/8 rounded-full -translate-y-20 translate-x-20"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-gradient-to-tr from-purple-400/8 to-pink-500/8 rounded-full translate-y-16 -translate-x-16"></div>
                    
                    <div class="relative">
                        <!-- Header Section -->
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center">
                                <div class="w-14 h-14 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center mr-4 shadow-xl">
                                    <i class="fas fa-chart-bar text-white text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold bg-gradient-to-r from-gray-800 via-blue-700 to-indigo-800 bg-clip-text text-transparent">
                                        System Performance
                                    </h3>
                                    <p class="text-gray-600 text-sm font-medium">Real-time system metrics</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="px-4 py-2 bg-gradient-to-r from-green-100 to-emerald-100 rounded-full border border-green-200/50">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                        <span class="text-sm font-semibold text-green-700">Live</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Professional KPI Grid -->
                        <div class="grid grid-cols-2 gap-6">
                            <!-- Total Businesses KPI -->
                            <div class="group relative overflow-hidden bg-gradient-to-br from-white to-blue-50/30 rounded-2xl p-6 backdrop-blur-sm border border-white/40 hover:border-blue-200/60 transition-all duration-500 hover:shadow-xl hover:-translate-y-2 cursor-pointer">
                                <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-indigo-600/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-building text-white text-lg"></i>
                                        </div>
                                        <div class="text-right">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-blue-600 text-sm font-bold uppercase tracking-wider">Total Businesses</p>
                                        <p class="text-3xl font-black text-blue-800 group-hover:text-blue-900 transition-colors" id="totalBusinesses">0</p>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full font-medium" id="businessGrowth">+0%</span>
                                            <span class="text-xs text-gray-500">this month</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Total Users KPI -->
                            <div class="group relative overflow-hidden bg-gradient-to-br from-white to-green-50/30 rounded-2xl p-6 backdrop-blur-sm border border-white/40 hover:border-green-200/60 transition-all duration-500 hover:shadow-xl hover:-translate-y-2 cursor-pointer">
                                <div class="absolute inset-0 bg-gradient-to-br from-green-500/5 to-emerald-600/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-users text-white text-lg"></i>
                                        </div>
                                        <div class="text-right">
                                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-green-600 text-sm font-bold uppercase tracking-wider">Total Users</p>
                                        <p class="text-3xl font-black text-green-800 group-hover:text-green-900 transition-colors" id="totalUsers">0</p>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-medium" id="userGrowth">+0%</span>
                                            <span class="text-xs text-gray-500">this month</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- System Activity KPI -->
                            <div class="group relative overflow-hidden bg-gradient-to-br from-white to-orange-50/30 rounded-2xl p-6 backdrop-blur-sm border border-white/40 hover:border-orange-200/60 transition-all duration-500 hover:shadow-xl hover:-translate-y-2 cursor-pointer">
                                <div class="absolute inset-0 bg-gradient-to-br from-orange-500/5 to-red-600/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-heartbeat text-white text-lg"></i>
                                        </div>
                                        <div class="text-right">
                                            <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-orange-600 text-sm font-bold uppercase tracking-wider">System Activity</p>
                                        <p class="text-3xl font-black text-orange-800 group-hover:text-orange-900 transition-colors" id="systemActivity">0</p>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs px-2 py-1 bg-orange-100 text-orange-700 rounded-full font-medium">Last 7 days</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- System Health KPI -->
                            <div class="group relative overflow-hidden bg-gradient-to-br from-white to-purple-50/30 rounded-2xl p-6 backdrop-blur-sm border border-white/40 hover:border-purple-200/60 transition-all duration-500 hover:shadow-xl hover:-translate-y-2 cursor-pointer">
                                <div class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-violet-600/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-shield-alt text-white text-lg"></i>
                                        </div>
                                        <div class="text-right">
                                            <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-purple-600 text-sm font-bold uppercase tracking-wider">System Health</p>
                                        <p class="text-3xl font-black text-purple-800 group-hover:text-purple-900 transition-colors">99.9%</p>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded-full font-medium">Operational</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let systemStats = {};
let businessGrowthChart = null;
let subscriptionChart = null;
let employeeData = {};
let currentPage = 1;
let currentSearch = '';
let currentBusinessFilter = '';

// Load system statistics
async function loadSystemStats() {
    try {
        console.log('Loading system stats...');
        const response = await fetch('/system-admin/api/stats');
        
        if (!response.ok) {
            console.error('System stats API response not ok:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('Error response body:', errorText);
            return;
        }
        
        const data = await response.json();
        console.log('System stats loaded:', data);
        
        systemStats = data;
        updateDashboardCards();
    } catch (error) {
        console.error('Error loading system stats:', error);
    }
}

// Update dashboard cards
function updateDashboardCards() {
    // Update main KPI cards
    document.getElementById('totalBusinesses').textContent = systemStats.total_businesses || 0;
    document.getElementById('totalUsers').textContent = systemStats.total_users || 0;
    document.getElementById('systemActivity').textContent = systemStats.system_activity || 0;
    
    // Calculate and display growth percentages
    const businessGrowth = calculateGrowthPercentage(systemStats.recent_businesses || 0, systemStats.total_businesses || 0);
    const userGrowth = calculateGrowthPercentage(systemStats.recent_users || 0, systemStats.total_users || 0);
    
    document.getElementById('businessGrowth').textContent = `+${businessGrowth}%`;
    document.getElementById('userGrowth').textContent = `+${userGrowth}%`;
}

// Calculate growth percentage
function calculateGrowthPercentage(recent, total) {
    if (total === 0) return 0;
    return Math.round((recent / total) * 100);
}

// Simplified for new design - no charts needed

// Load employee data
async function loadEmployeeData(page = 1, search = '', businessId = '') {
    try {
        console.log('Loading employee data...');
        const params = new URLSearchParams({
            page: page,
            per_page: 10,
            search: search,
            business_id: businessId
        });
        
        const response = await fetch(`/system-admin/businesses/api/employee-details?${params}`);
        
        if (!response.ok) {
            console.error('Employee data API response not ok:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('Error response body:', errorText);
            return;
        }
        
        const data = await response.json();
        console.log('Employee data loaded:', data);
        
        employeeData = data;
        updateEmployeeCards();
        renderEmployeeTable();
        updatePagination();
        loadBusinessFilter();
    } catch (error) {
        console.error('Error loading employee data:', error);
    }
}

// Update employee summary cards
function updateEmployeeCards() {
    const stats = employeeData.statistics || {};
    
    document.getElementById('totalEmployees').textContent = stats.total_employees || 0;
    document.getElementById('activeEmployees').textContent = stats.active_employees || 0;
    
    const roleStats = stats.role_distribution || {};
    document.getElementById('systemAdmins').textContent = roleStats.system_administrator || 0;
    document.getElementById('businessOwners').textContent = roleStats.admin || 0;
}

// Render employee table
function renderEmployeeTable() {
    const tbody = document.getElementById('employeeTableBody');
    const employees = employeeData.employees || [];
    
    if (employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No employees found</td></tr>';
        return;
    }
    
    tbody.innerHTML = employees.map(employee => {
        const joinedDate = new Date(employee.created_at).toLocaleDateString();
        const statusBadge = employee.is_active 
            ? '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Active</span>'
            : '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Inactive</span>';
        
        const roleBadges = {
            'system_administrator': 'system_admin',
            'admin': 'bg-blue-100 text-blue-800',
            'manager': 'bg-green-100 text-green-800',
            'employee': 'bg-gray-100 text-gray-800'
        };
        
        const roleClass = roleBadges[employee.role] || roleBadges.employee;
        const roleDisplay = employee.role === 'system_administrator' ? 'system_admin' : employee.role;
        
        return `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">${employee.full_name ? employee.full_name.charAt(0).toUpperCase() : 'M'}</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${employee.full_name || 'Muhammad Mamoon'}</p>
                            <p class="text-sm text-gray-500">${employee.email}</p>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-6">
                    <div>
                        <p class="font-medium text-gray-900">${employee.business ? employee.business.name : 'TSG Cafe System'}</p>
                        <p class="text-sm text-gray-500">${employee.business ? employee.business.subscription_plan : 'premium'}</p>
                    </div>
                </td>
                <td class="py-3 px-6">
                    <span class="px-2 py-1 text-xs font-medium ${roleClass === 'system_admin' ? 'text-purple-600' : roleClass} rounded-full">${roleDisplay}</span>
                </td>
                <td class="py-3 px-6 text-gray-700">${employee.department || 'Management'}</td>
                <td class="py-3 px-6">${statusBadge}</td>
                <td class="py-3 px-6 text-gray-700">${joinedDate}</td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('employeeCount').textContent = employees.length;
}

// Load business filter options
async function loadBusinessFilter() {
    try {
        const response = await fetch('/admin/api/businesses');
        const data = await response.json();
        
        if (response.ok) {
            const select = document.getElementById('businessFilter');
            select.innerHTML = '<option value="">All Businesses</option>';
            
            data.businesses.forEach(business => {
                const option = document.createElement('option');
                option.value = business.id;
                option.textContent = business.business_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading business filter:', error);
    }
}

// Update pagination
function updatePagination() {
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= (employeeData.pages || 1);
    
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            loadEmployeeData(currentPage, currentSearch, currentBusinessFilter);
        }
    };
    
    nextBtn.onclick = () => {
        if (currentPage < (employeeData.pages || 1)) {
            currentPage++;
            loadEmployeeData(currentPage, currentSearch, currentBusinessFilter);
        }
    };
}

// Refresh employee data
function refreshEmployeeData() {
    currentPage = 1;
    loadEmployeeData(currentPage, currentSearch, currentBusinessFilter);
}

// Profile picture upload function
async function uploadProfilePicture(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            showNotification('Please select a valid image file', 'error');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Image size must be less than 5MB', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('profile_picture', file);
        
        try {
            const response = await fetch('/api/upload-profile-picture', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                // Update the profile picture display in employee details
                const profileImg = document.querySelector('#profilePictureInput').parentElement.querySelector('img');
                if (profileImg) {
                    profileImg.src = result.profile_picture_url;
                } else {
                    // If no img tag exists, create one and replace the icon
                    const container = document.querySelector('#profilePictureInput').parentElement;
                    container.innerHTML = `<img src="${result.profile_picture_url}" alt="Profile" class="w-full h-full object-cover">`;
                }
                
                // Also update the navigation profile icon
                const navProfileIcon = document.getElementById('userProfileIcon');
                if (navProfileIcon) {
                    navProfileIcon.innerHTML = `<img src="${result.profile_picture_url}" alt="Profile" class="w-full h-full object-cover">`;
                }
                
                showNotification('Profile picture updated successfully!', 'success');
            } else {
                showNotification(result.error || 'Failed to upload profile picture', 'error');
            }
        } catch (error) {
            console.error('Error uploading profile picture:', error);
            showNotification('An error occurred while uploading profile picture', 'error');
        }
    }
}

// Simple notification function
function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 3000);
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStats();
});
</script>
{% endblock %}
