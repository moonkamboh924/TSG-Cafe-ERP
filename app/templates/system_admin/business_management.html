{% extends "system_admin/base.html" %}

{% block title %}Business Management - System Admin{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Business Management</h1>
                <p class="text-gray-600 mt-2">Monitor and manage all registered businesses across the platform.</p>
            </div>
            <div class="flex gap-3">
                <button id="refreshBusinesses" class="bg-white border border-gray-200 px-4 py-2 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-50 transition flex items-center gap-2">
                    <i class="fas fa-rotate"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <p class="text-sm text-gray-500">Total Businesses</p>
                <p class="text-3xl font-semibold text-gray-900" id="statsTotal">{{ total_businesses }}</p>
            </div>
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <p class="text-sm text-gray-500">Active Businesses</p>
                <p class="text-3xl font-semibold text-green-600" id="statsActive">{{ active_businesses }}</p>
            </div>
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <p class="text-sm text-gray-500">Recently Created</p>
                <p class="text-3xl font-semibold text-blue-600">{{ recent_businesses|length }}</p>
            </div>
        </div>

        <!-- Search & Filters -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">Search</label>
                    <div class="mt-2 relative">
                        <input id="businessSearch" type="text" placeholder="Search business name, email, ID..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <span class="absolute inset-y-0 right-3 flex items-center text-gray-400"><i class="fas fa-search"></i></span>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">Status</label>
                    <select id="businessStatus" class="mt-2 w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="resetFilters" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 hover:bg-gray-50">Reset</button>
                </div>
            </div>
        </div>

        <!-- Business Table -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-white">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Business</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subscription</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Users</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="businessTable" class="bg-white divide-y divide-gray-100">
                        <!-- rows injected by JS -->
                    </tbody>
                </table>
            </div>

            <div class="p-6 border-t border-gray-100 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <span class="text-sm text-gray-500" id="businessSummary">Loading...</span>
                <div class="flex gap-2">
                    <button id="prevPage" class="px-4 py-2 border border-gray-200 rounded-xl text-sm text-gray-600 hover:bg-gray-50" disabled>
                        <i class="fas fa-chevron-left mr-1"></i>Prev
                    </button>
                    <button id="nextPage" class="px-4 py-2 border border-gray-200 rounded-xl text-sm text-gray-600 hover:bg-gray-50" disabled>
                        Next<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="fixed inset-0 bg-black/50 hidden z-50 p-6">
    <div class="bg-white rounded-2xl max-w-md mx-auto shadow-2xl">
        <div class="p-6">
            <h3 class="text-xl font-bold text-gray-800" id="confirmTitle">Confirm Action</h3>
            <p class="text-gray-600 mt-3" id="confirmMessage">Are you sure?</p>
            <div class="flex justify-end gap-3 mt-6">
                <button class="px-4 py-2 border border-gray-300 rounded-xl text-gray-700" onclick="confirmationModal.close()">Cancel</button>
                <button class="px-4 py-2 bg-red-600 text-white rounded-xl" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div id="businessDetailsModal" class="fixed inset-0 bg-black/50 hidden z-50 p-6 overflow-y-auto">
    <div class="bg-white rounded-2xl max-w-3xl mx-auto shadow-2xl">
        <div class="flex justify-between items-center border-b px-6 py-4">
            <div>
                <h3 class="text-xl font-bold text-gray-800" id="detailsName">Business Details</h3>
                <p class="text-sm text-gray-500">Created <span id="detailsCreated">—</span></p>
            </div>
            <button class="text-gray-400 hover:text-gray-600" onclick="businessApp.closeDetails()"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
                <p class="text-gray-500">Owner Email</p>
                <p class="font-semibold text-gray-900" id="detailsEmail">—</p>
            </div>
            <div>
                <p class="text-gray-500">Subscription Plan</p>
                <p class="font-semibold text-indigo-600" id="detailsPlan">—</p>
            </div>
            <div>
                <p class="text-gray-500">Status</p>
                <p class="font-semibold" id="detailsStatus">—</p>
            </div>
            <div>
                <p class="text-gray-500">Users</p>
                <p class="font-semibold" id="detailsUsers">—</p>
            </div>
            <div>
                <p class="text-gray-500">Last Updated</p>
                <p class="font-semibold" id="detailsUpdated">—</p>
            </div>
        </div>
        <div class="flex justify-end px-6 py-4 border-t">
            <button class="px-4 py-2 bg-blue-600 text-white rounded-xl" onclick="businessApp.closeDetails()">Close</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editBusinessModal" class="fixed inset-0 bg-black/50 hidden z-50 p-6 overflow-y-auto">
    <div class="bg-white rounded-2xl max-w-3xl mx-auto shadow-2xl">
        <div class="flex justify-between items-center border-b px-6 py-4">
            <h3 class="text-xl font-bold text-gray-800">Edit Business</h3>
            <button class="text-gray-400 hover:text-gray-600" onclick="businessApp.closeEdit()"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="text-sm font-medium text-gray-500">Business Name</label>
                <input id="editBusinessName" type="text" class="mt-2 w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Owner Email</label>
                <input id="editOwnerEmail" type="email" class="mt-2 w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Subscription Plan</label>
                <select id="editSubscription" class="mt-2 w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="free">Free</option>
                    <option value="basic">Basic</option>
                    <option value="premium">Premium</option>
                </select>
            </div>
            <div class="flex items-center mt-8">
                <input id="editIsActive" type="checkbox" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label class="ml-2 text-sm font-medium text-gray-700">Active</label>
            </div>
        </div>
        <div class="flex justify-end gap-3 px-6 py-4 border-t" data-business-id="">
            <button class="px-4 py-2 border border-gray-200 rounded-xl text-gray-700" onclick="businessApp.closeEdit()">Cancel</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded-xl" onclick="businessApp.saveEdit()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Users Modal -->
<div id="businessUsersModal" class="fixed inset-0 bg-black/50 hidden z-50 p-6 overflow-y-auto">
    <div class="bg-white rounded-2xl max-w-4xl mx-auto shadow-2xl">
        <div class="flex justify-between items-center border-b px-6 py-4">
            <div>
                <h3 class="text-xl font-bold text-gray-800">Business Users</h3>
                <p class="text-sm text-gray-500" id="businessUsersSubtitle"></p>
            </div>
            <button class="text-gray-400 hover:text-gray-600" onclick="closeBusinessUsersModal()"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-6 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500">User</th>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500">Role</th>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500">Status</th>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500">Actions</th>
                    </tr>
                </thead>
                <tbody id="businessUsersTable" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
        <div class="flex justify-end px-6 py-4 border-t">
            <button class="px-4 py-2 bg-blue-600 text-white rounded-xl" onclick="closeBusinessUsersModal()">Close</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentSearch = '';
let currentStatus = '';

const notify = (message, type = 'info') => {
    if (typeof window.showNotification === 'function') {
        window.showNotification(message, type);
    } else {
        if (type === 'error') {
            console.error(message);
        } else {
            console.log(message);
        }
    }
};

async function loadBusinesses(page = 1) {
    try {
        const params = new URLSearchParams({
            page,
            search: currentSearch,
            status: currentStatus
        });
        const response = await fetch(`/system-admin/businesses/api/list?${params.toString()}`);
        const result = await response.json();

        if (!response.ok) throw new Error(result.error || 'Failed to load businesses');

        const tbody = document.getElementById('businessTable');
        tbody.innerHTML = '';

        result.businesses.forEach((biz) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4">
                    <div class="font-semibold text-gray-900">${biz.business_name}</div>
                    <div class="text-sm text-gray-500">Created ${new Date(biz.created_at).toLocaleDateString()}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-gray-900">${biz.owner_email || '—'}</div>
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-indigo-50 text-indigo-700">${biz.subscription_plan}</span>
                </td>
                <td class="px-6 py-4 text-gray-700">${biz.user_count}</td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${biz.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                        ${biz.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="px-6 py-4 text-right">
                    <div class="flex justify-end gap-3 text-sm">
                        <button class="text-blue-600 hover:text-blue-800" onclick="businessApp.openDetails(${biz.id})">Details</button>
                        <button class="text-slate-600 hover:text-slate-800" onclick="businessApp.openEdit(${biz.id})">Edit</button>
                        <button class="text-red-600 hover:text-red-800" onclick="businessApp.openDelete(${biz.id}, '${biz.business_name}')">Delete</button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        currentPage = result.current_page;
        document.getElementById('businessSummary').textContent = `Showing ${result.businesses.length} of ${result.total} business(es)`;
        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= result.pages;
    } catch (error) {
        notify(error.message, 'error');
    }
}

function ensureConfirmationModal() {
    let modal = document.getElementById('confirmationModal');
    if (modal) return modal;

    modal = document.createElement('div');
    modal.id = 'confirmationModal';
    modal.className = 'fixed inset-0 bg-black/50 hidden z-50 p-6';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-md mx-auto shadow-2xl">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800" id="confirmTitle">Confirm Action</h3>
                <p class="text-gray-600 mt-3" id="confirmMessage">Are you sure?</p>
                <div class="flex justify-end gap-3 mt-6">
                    <button class="px-4 py-2 border border-gray-300 rounded-xl text-gray-700" onclick="confirmationModal.close()">Cancel</button>
                    <button class="px-4 py-2 bg-red-600 text-white rounded-xl" id="confirmButton">Confirm</button>
                </div>
            </div>
        </div>`;
    document.body.appendChild(modal);
    return modal;
}

const confirmationModal = {
    open({ title, message, confirmText = 'Confirm', onConfirm }) {
        const modal = ensureConfirmationModal();
        const titleEl = modal.querySelector('#confirmTitle');
        const messageEl = modal.querySelector('#confirmMessage');
        const button = modal.querySelector('#confirmButton');
        if (!modal || !titleEl || !messageEl || !button) {
            notify('Confirmation dialog unavailable.', 'error');
            return;
        }
        titleEl.textContent = title;
        messageEl.textContent = message;
        button.textContent = confirmText;
        button.onclick = () => {
            onConfirm?.();
            confirmationModal.close();
        };
        modal.classList.add('show');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    },
    close() {
        const modal = document.getElementById('confirmationModal');
        if (!modal) return;
        modal.classList.remove('show');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
};

const confirmButton = document.getElementById('confirmButton');
if (confirmButton) {
    confirmButton.addEventListener('click', () => confirmationModal.close());
}

function businessManager() {
    return {
        currentPage: 1,
        currentSearch: '',
        currentStatus: '',
        selectedBusiness: null,
        loading: false,

        async loadBusinesses(page = 1, force = false) {
            if (this.loading && !force) return;
            this.loading = true;
            try {
                const params = new URLSearchParams({
                    page,
                    search: this.currentSearch,
                    status: this.currentStatus
                });
                const response = await fetch(`/system-admin/businesses/api/list?${params}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to load businesses');

                const tbody = document.getElementById('businessTable');
                tbody.innerHTML = '';
                data.businesses.forEach((biz) => {
                    const row = document.createElement('tr');
                    row.innerHTML = this.rowTemplate(biz);
                    tbody.appendChild(row);
                });

                this.currentPage = data.current_page;
                document.getElementById('businessSummary').textContent = `Showing ${data.businesses.length} of ${data.total} business(es)`;
                document.getElementById('prevPage').disabled = this.currentPage <= 1;
                document.getElementById('nextPage').disabled = this.currentPage >= data.pages;
            } catch (error) {
                notify(error.message, 'error');
            } finally {
                this.loading = false;
            }
        },

        rowTemplate(biz) {
            return `
            <td class="px-6 py-4">
                <div class="font-semibold text-gray-900">${biz.business_name}</div>
                <div class="text-sm text-gray-500">Created ${new Date(biz.created_at).toLocaleDateString()}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-gray-900">${biz.owner_email || '—'}</div>
            </td>
            <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-medium bg-indigo-50 text-indigo-700">${biz.subscription_plan}</span>
            </td>
            <td class="px-6 py-4 text-gray-700">${biz.user_count}</td>
            <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-medium ${biz.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                    ${biz.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td class="px-6 py-4 text-right">
                <div class="flex justify-end gap-3 text-sm">
                    <button class="text-blue-600 hover:text-blue-800" onclick="businessApp.openDetails(${biz.id})">Details</button>
                    <button class="text-slate-600 hover:text-slate-800" onclick="businessApp.openEdit(${biz.id})">Edit</button>
                    <button class="text-red-600 hover:text-red-800" onclick="businessApp.openDelete(${biz.id}, '${biz.business_name}')">Delete</button>
                </div>
            </td>`;
        },

        async openDetails(id) {
            await this.fetchBusiness(id, (business) => {
                document.getElementById('detailsName').textContent = business.business_name;
                document.getElementById('detailsEmail').textContent = business.owner_email || '—';
                document.getElementById('detailsPlan').textContent = business.subscription_plan;
                document.getElementById('detailsStatus').textContent = business.is_active ? 'Active' : 'Inactive';
                document.getElementById('detailsUsers').textContent = business.user_count;
                document.getElementById('detailsCreated').textContent = new Date(business.created_at).toLocaleString();
                document.getElementById('detailsUpdated').textContent = business.updated_at ? new Date(business.updated_at).toLocaleString() : '—';
                document.getElementById('businessDetailsModal').classList.remove('hidden');
            });
        },

        async openEdit(id) {
            await this.fetchBusiness(id, (business) => {
                this.selectedBusiness = business;
                document.getElementById('editBusinessName').value = business.business_name;
                document.getElementById('editOwnerEmail').value = business.owner_email || '';
                document.getElementById('editSubscription').value = business.subscription_plan;
                document.getElementById('editIsActive').checked = business.is_active;
                document.getElementById('editBusinessModal').classList.remove('hidden');
            });
        },

        openDelete(id, name) {
            confirmationModal.open({
                title: 'Delete Business',
                message: `Are you sure you want to delete "${name}"? All associated users will be detached.`,
                confirmText: 'Delete',
                onConfirm: () => this.deleteBusiness(id)
            });
        },

        async deleteBusiness(id) {
            try {
                const response = await fetch(`/system-admin/businesses/api/businesses/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to delete business');
                notify(data.message, 'success');
                this.loadBusinesses(this.currentPage);
            } catch (error) {
                notify(error.message, 'error');
            }
        },

        async saveEdit() {
            try {
                const payload = {
                    business_name: document.getElementById('editBusinessName').value,
                    owner_email: document.getElementById('editOwnerEmail').value,
                    subscription_plan: document.getElementById('editSubscription').value,
                    is_active: document.getElementById('editIsActive').checked
                };
                const response = await fetch(`/system-admin/businesses/api/businesses/${this.selectedBusiness.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to update');
                notify('Business updated successfully', 'success');
                this.closeEdit();
                this.loadBusinesses(this.currentPage);
            } catch (error) {
                notify(error.message, 'error');
            }
        },

        closeEdit() {
            document.getElementById('editBusinessModal').classList.add('hidden');
            this.selectedBusiness = null;
        },

        closeDetails() {
            document.getElementById('businessDetailsModal').classList.add('hidden');
        },

        async fetchBusiness(id, callback) {
            try {
                const response = await fetch(`/system-admin/businesses/api/businesses/${id}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Business not found');
                callback(data.business);
            } catch (error) {
                notify(error.message, 'error');
            }
        },

        async openUsers(id) {
            try {
                const response = await fetch(`/system-admin/businesses/api/${id}/users`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to load users');
                document.getElementById('businessUsersSubtitle').textContent = `${data.business.name} • ${data.total_users} User(s)`;
                const tbody = document.getElementById('businessUsersTable');
                tbody.innerHTML = '';
                data.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${user.full_name}</div>
                            <div class="text-sm text-gray-500">${user.email}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${user.role}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${user.is_active ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}">${user.is_active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-blue-600 space-x-3">
                            <button class="hover:underline" onclick="businessApp.toggleUser(${data.business.id}, ${user.id})">${user.is_active ? 'Deactivate' : 'Activate'}</button>
                            <button class="text-red-600 hover:underline" onclick="businessApp.removeUser(${data.business.id}, ${user.id}, '${user.full_name}')">Remove</button>
                        </td>`;
                    tbody.appendChild(row);
                });
                document.getElementById('businessUsersModal').classList.remove('hidden');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        },

        async removeUser(businessId, userId, name) {
            confirmationModal.open({
                title: 'Remove User',
                message: `Remove ${name} from this business?`,
                confirmText: 'Remove',
                onConfirm: async () => {
                    try {
                        const response = await fetch(`/system-admin/businesses/api/${businessId}/users/${userId}`, { method: 'DELETE' });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'Failed to remove user');
                        notify(data.message, 'success');
                        this.openUsers(businessId);
                    } catch (error) {
                        notify(error.message, 'error');
                    }
                }
            });
        },

        async toggleUser(businessId, userId) {
            try {
                const response = await fetch(`/system-admin/businesses/api/${businessId}/users/${userId}/toggle-status`, { method: 'POST' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to update user status');
                notify(data.message, 'success');
                this.openUsers(businessId);
            } catch (error) {
                notify(error.message, 'error');
            }
        }
    };
}

const businessApp = window.businessApp = businessManager();
document.addEventListener('DOMContentLoaded', () => {
    businessApp.loadBusinesses();
    const searchInput = document.getElementById('businessSearch');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            businessApp.currentSearch = e.target.value;
            businessApp.loadBusinesses();
        });
    }
    const statusSelect = document.getElementById('businessStatus');
    if (statusSelect) {
        statusSelect.addEventListener('change', (e) => {
            businessApp.currentStatus = e.target.value;
            businessApp.loadBusinesses();
        });
    }
    const resetButton = document.getElementById('resetFilters');
    if (resetButton) {
        resetButton.addEventListener('click', () => {
            businessApp.currentSearch = '';
            businessApp.currentStatus = '';
            if (searchInput) searchInput.value = '';
            if (statusSelect) statusSelect.value = '';
            businessApp.loadBusinesses();
        });
    }
    const prevButton = document.getElementById('prevPage');
    if (prevButton) {
        prevButton.addEventListener('click', () => {
            if (businessApp.currentPage > 1) businessApp.loadBusinesses(businessApp.currentPage - 1);
        });
    }
    const nextButton = document.getElementById('nextPage');
    if (nextButton) {
        nextButton.addEventListener('click', () => {
            businessApp.loadBusinesses(businessApp.currentPage + 1);
        });
    }
    const refreshButton = document.getElementById('refreshBusinesses');
    if (refreshButton) {
        refreshButton.addEventListener('click', () => {
            businessApp.loadBusinesses(businessApp.currentPage, true);
        });
    }
});
</script>
{% endblock %}
