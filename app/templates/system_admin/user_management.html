{% extends "system_admin/base.html" %}

{% block title %}User Management - TSG Cafe ERP{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
    <div class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">System Administrator Management</h1>
                <p class="text-gray-600 mt-2">Manage system administrator accounts and permissions</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="openAddUserModal()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-user-plus mr-2"></i>Add System Administrator
                </button>
            </div>
        </div>

        <!-- System Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">System Administrators</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalUsers">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Admins</p>
                        <p class="text-3xl font-bold text-green-600" id="activeSessions">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">System Health</p>
                        <p class="text-3xl font-bold text-green-600" id="systemHealth">Good</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-shield-alt text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Database Size</p>
                        <p class="text-3xl font-bold text-purple-600" id="databaseSize">0 MB</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-database text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="bg-white/70 backdrop-blur-sm rounded-2xl border border-white/40 shadow-lg">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">User Management</h3>
                </div>
                
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="roleFilter" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">System Administrators</option>
                        <option value="system_administrator">System Administrator</option>
                    </select>
                    
                    <select id="statusFilter" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    
                    <input type="text" id="userSearch" placeholder="Search users..." class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    
                    <button onclick="resetFilters()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Reset Filters
                    </button>
                </div>
            </div>
            
            <!-- User Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-6 font-semibold text-gray-700">User</th>
                            <th class="text-left py-3 px-6 font-semibold text-gray-700">Email</th>
                            <th class="text-left py-3 px-6 font-semibold text-gray-700">Role</th>
                            <th class="text-left py-3 px-6 font-semibold text-gray-700">Status</th>
                            <th class="text-left py-3 px-6 font-semibold text-gray-700">Navigation Permissions</th>
                            <th class="text-left py-3 px-6 font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- User data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="p-6 border-t border-gray-200 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    Showing <span id="userCount">0</span> users
                </div>
                <div class="flex space-x-2">
                    <button id="prevPage" class="px-4 py-2 border border-gray-200 rounded-lg text-sm hover:bg-gray-50 transition-colors" disabled>
                        <i class="fas fa-chevron-left mr-1"></i> Previous
                    </button>
                    <button id="nextPage" class="px-4 py-2 border border-gray-200 rounded-lg text-sm hover:bg-gray-50 transition-colors" disabled>
                        Next <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add System Administrator Modal -->
<div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-user-plus text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Add System Administrator</h3>
                        <p class="text-gray-600 text-sm">Create a new system administrator account</p>
                    </div>
                </div>
                <button onclick="closeAddUserModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <form id="addUserForm" class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Personal Information -->
                <div class="md:col-span-2">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-user mr-2 text-blue-600"></i>Personal Information
                    </h4>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                    <input type="text" id="firstName" name="first_name" required 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                    <input type="text" id="lastName" name="last_name" required 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                    <input type="email" id="email" name="email" required 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="phone" name="phone" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                    <input type="text" id="fullName" name="full_name" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter full name">
                </div>
                
                <!-- Professional Information -->
                <div class="md:col-span-2 mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-4">
                        <i class="fas fa-briefcase text-blue-600 mr-2"></i>Professional Information
                    </h4>
                </div>
                
                <div>
                    <label for="role" class="block text-sm font-medium text-gray-700 mb-2">System Administrator Role *</label>
                    <select id="role" name="role" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                        <option value="">Select Role</option>
                        <option value="Manager">üëî Manager</option>
                        <option value="Executive">üèÜ Executive</option>
                        <option value="Officer">üëÆ Officer</option>
                    </select>
                </div>
                
                <div>
                    <label for="designation" class="block text-sm font-medium text-gray-700 mb-2">Designation</label>
                    <input type="text" id="designation" name="designation" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., Senior System Administrator">
                </div>
                
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <input type="text" id="department" name="department" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., IT Operations">
                </div>
                
                <!-- Security Information -->
                <div class="md:col-span-2 mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-shield-alt mr-2 text-blue-600"></i>Security Settings
                    </h4>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" name="username" readonly
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-600 cursor-not-allowed"
                           placeholder="Auto-generated from name">
                    <p class="text-xs text-gray-500 mt-1">Username will be auto-generated as: First letter + Last letter + Number</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" required value="1234@1234"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-12">
                        <button type="button" onclick="togglePasswordVisibility('password')" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Default password: 1234@1234 (User can change after login)</p>
                    <div id="passwordStrength" class="mt-2"></div>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <textarea id="address" name="address" rows="3" 
                              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                
                <!-- Account Settings -->
                <div class="md:col-span-2 mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-cogs mr-2 text-blue-600"></i>Account Settings
                    </h4>
                </div>
                
                <div class="md:col-span-2">
                    <div class="flex items-center space-x-6">
                        <label class="flex items-center">
                            <input type="checkbox" id="isActive" name="is_active" checked 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">Account Active</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="isProtected" name="is_protected" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">Protected Account</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="requirePasswordChange" name="requires_password_change" checked 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">Require Password Change</span>
                        </label>
                    </div>
                </div>
                
                <!-- Navigation Permissions -->
                <div class="md:col-span-2 mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-key mr-2 text-blue-600"></i>Navigation Permissions
                    </h4>
                </div>
                
                <div class="md:col-span-2">
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-medium text-gray-700">Select Access Permissions:</span>
                            <div class="flex space-x-2">
                                <button type="button" onclick="selectAllPermissions()" 
                                        class="text-xs px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Select All
                                </button>
                                <button type="button" onclick="clearAllPermissions()" 
                                        class="text-xs px-3 py-1 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                    Clear All
                                </button>
                            </div>
                        </div>
                        
                        <!-- System Dashboard - Permanent Permission -->
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center">
                                <i class="fas fa-lock text-blue-600 mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium text-blue-800">Permanent Permission</p>
                                    <p class="text-xs text-blue-600">System Dashboard access is automatically granted to all system administrators</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="permissions" value="user_management" checked 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-users-cog text-green-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">User Management</span>
                                    </div>
                                    <p class="text-xs text-gray-500">System administrator users</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="permissions" value="business_management" checked 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-building text-orange-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">Business Management</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Tenant businesses</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="permissions" value="subscription_management" checked 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-credit-card text-blue-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">Subscription Management</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Business subscriptions & billing</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="permissions" value="system_settings" checked 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-cogs text-purple-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">System Settings</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Global configuration</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="permissions" value="system_analytics" checked 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-chart-line text-indigo-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">System Analytics</span>
                                    </div>
                                    <p class="text-xs text-gray-500">System performance analytics</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="permissions" value="monitoring" checked 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-heartbeat text-yellow-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">Monitoring</span>
                                    </div>
                                    <p class="text-xs text-gray-500">System health monitoring</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="permissions" value="reports" checked 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-file-alt text-teal-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">Reports</span>
                                    </div>
                                    <p class="text-xs text-gray-500">System reports & analytics</p>
                                </div>
                            </label>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mt-0.5 mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium text-blue-800">System Administrator Permission Guidelines:</p>
                                    <ul class="text-xs text-blue-700 mt-1 space-y-1">
                                        <li>‚Ä¢ System Dashboard access is automatically granted to all system administrators</li>
                                        <li>‚Ä¢ User Management allows managing system administrator accounts</li>
                                        <li>‚Ä¢ Business Management provides oversight of tenant businesses</li>
                                        <li>‚Ä¢ Subscription Management handles billing and subscription plans</li>
                                        <li>‚Ä¢ System Settings, Analytics, Monitoring, and Reports provide system insights</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
                <button type="button" onclick="closeAddUserModal()" 
                        class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-user-plus mr-2"></i>Create Administrator
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit System Administrator Modal -->
<div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-user-edit text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Edit System Administrator</h3>
                        <p class="text-gray-600 text-sm">Update system administrator account details</p>
                    </div>
                </div>
                <button onclick="closeEditUserModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <form id="editUserForm" class="p-6">
            <input type="hidden" id="editUserId" name="user_id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Personal Information -->
                <div class="md:col-span-2">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-user mr-2 text-blue-600"></i>Personal Information
                    </h4>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                    <input type="text" id="editFirstName" name="first_name" required 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                    <input type="text" id="editLastName" name="last_name" required 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                    <input type="email" id="editEmail" name="email" required 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="editPhone" name="phone" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                    <input type="text" id="editFullName" name="full_name" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter full name">
                </div>
                
                <!-- Professional Information -->
                <div class="md:col-span-2 mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-briefcase mr-2 text-blue-600"></i>Professional Information
                    </h4>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">System Administrator Role *</label>
                    <select id="editRole" name="role" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                        <option value="">Select Role</option>
                        <option value="Manager">üëî Manager</option>
                        <option value="Executive">üèÜ Executive</option>
                        <option value="Officer">üëÆ Officer</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Designation</label>
                    <input type="text" id="editDesignation" name="designation" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <select id="editDepartment" name="department" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Department</option>
                        <option value="Management">Management</option>
                        <option value="IT">Information Technology</option>
                        <option value="Operations">Operations</option>
                        <option value="Finance">Finance</option>
                        <option value="Support">Support</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <textarea id="editAddress" name="address" rows="3" 
                              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                
                <!-- Navigation Permissions -->
                <div class="md:col-span-2 mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-key mr-2 text-blue-600"></i>Navigation Permissions
                    </h4>
                </div>
                
                <div class="md:col-span-2">
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-medium text-gray-700">Select Access Permissions:</span>
                            <div class="flex space-x-2">
                                <button type="button" onclick="selectAllEditPermissions()" 
                                        class="text-xs px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Select All
                                </button>
                                <button type="button" onclick="clearAllEditPermissions()" 
                                        class="text-xs px-3 py-1 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                    Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="edit_permissions" value="user_management" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-users-cog text-green-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">User Management</span>
                                    </div>
                                    <p class="text-xs text-gray-500">System administrator users</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="edit_permissions" value="business_management" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-building text-orange-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">Business Management</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Tenant businesses</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="edit_permissions" value="subscription_management" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-credit-card text-blue-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">Subscription Management</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Business subscriptions & billing</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="edit_permissions" value="system_settings" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-cogs text-purple-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">System Settings</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Global configuration</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="edit_permissions" value="system_analytics" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-chart-line text-indigo-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">System Analytics</span>
                                    </div>
                                    <p class="text-xs text-gray-500">System performance analytics</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="edit_permissions" value="monitoring" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-heartbeat text-yellow-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">Monitoring</span>
                                    </div>
                                    <p class="text-xs text-gray-500">System health monitoring</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer min-h-[80px]">
                                <input type="checkbox" name="edit_permissions" value="reports" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center mb-1">
                                        <i class="fas fa-file-alt text-teal-600 mr-2"></i>
                                        <span class="text-sm font-medium text-gray-900">Reports</span>
                                    </div>
                                    <p class="text-xs text-gray-500">System reports & analytics</p>
                                </div>
                            </label>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mt-0.5 mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium text-blue-800">System Administrator Permission Guidelines:</p>
                                    <ul class="text-xs text-blue-700 mt-1 space-y-1">
                                        <li>‚Ä¢ System Dashboard access is automatically granted to all system administrators</li>
                                        <li>‚Ä¢ User Management allows managing system administrator accounts</li>
                                        <li>‚Ä¢ Business Management provides oversight of tenant businesses</li>
                                        <li>‚Ä¢ Subscription Management handles billing and subscription plans</li>
                                        <li>‚Ä¢ System Settings, Analytics, Monitoring, and Reports provide system insights</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Account Settings -->
                <div class="md:col-span-2 mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-cogs mr-2 text-blue-600"></i>Account Settings
                    </h4>
                </div>
                
                <div class="md:col-span-2">
                    <div class="flex items-center space-x-6">
                        <label class="flex items-center">
                            <input type="checkbox" id="editIsActive" name="is_active" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">Account Active</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="editIsProtected" name="is_protected" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">Protected Account</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
                <button type="button" onclick="closeEditUserModal()" 
                        class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-save mr-2"></i>Update Administrator
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

<!-- Enhanced Notification Container -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-3 max-w-sm"></div>

<!-- Custom Confirmation Modal -->
<div id="confirmationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] opacity-0 invisible transition-all duration-300">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform scale-95 transition-all duration-300" id="confirmationContent">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-pink-500 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900" id="confirmTitle">Confirm Action</h3>
                    <p class="text-sm text-gray-500">This action requires confirmation</p>
                </div>
            </div>
            
            <!-- Message -->
            <div class="mb-6">
                <p class="text-gray-700" id="confirmMessage">Are you sure you want to proceed?</p>
            </div>
            
            <!-- Actions -->
            <div class="flex space-x-3">
                <button type="button" onclick="closeConfirmationModal()" 
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="button" id="confirmButton"
                        class="flex-1 px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-trash mr-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Notification & Modal Styles -->
<style>
/* Notification Animations */
.notification {
    transform: translateX(100%) scale(0.9);
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    opacity: 0;
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    position: relative;
}

.notification::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s ease;
}

.notification:hover::before {
    left: 100%;
}

.notification.show {
    transform: translateX(0) scale(1);
    opacity: 1;
}

.notification.hide {
    transform: translateX(100%) scale(0.8);
    opacity: 0;
}

/* Enhanced Notification Types */
.notification-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-left: 4px solid #047857;
    box-shadow: 
        0 8px 32px rgba(16, 185, 129, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.notification-error {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border-left: 4px solid #b91c1c;
    box-shadow: 
        0 8px 32px rgba(239, 68, 68, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.notification-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-left: 4px solid #b45309;
    box-shadow: 
        0 8px 32px rgba(245, 158, 11, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.notification-info {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-left: 4px solid #1d4ed8;
    box-shadow: 
        0 8px 32px rgba(59, 130, 246, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

/* Confirmation Modal Animations */
#confirmationModal.show {
    opacity: 1;
    visibility: visible;
}

#confirmationModal.show #confirmationContent {
    transform: scale(1);
}

/* Notification Container Improvements */
#notificationContainer {
    pointer-events: none;
}

#notificationContainer .notification {
    pointer-events: auto;
}

/* Close button hover effects */
.notification button:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}
</style>

{% block extra_js %}
<script>
let currentPage = 1;
let currentSearch = '';
let currentRole = '';
let currentStatus = '';

// Load user statistics
async function loadUserStats() {
    try {
        const response = await fetch('/system-admin/users/api/stats');
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('totalUsers').textContent = data.total_users || 0;
            document.getElementById('activeSessions').textContent = data.active_sessions || 0;
            document.getElementById('systemHealth').textContent = data.system_health || 'Good';
            document.getElementById('databaseSize').textContent = data.database_size || '0 MB';
        }
    } catch (error) {
        console.error('Error loading user stats:', error);
    }
}

// Load users data
async function loadUsers(page = 1, search = '', role = '', status = '') {
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 25,
            search: search,
            role: role,
            status: status
        });
        
        const response = await fetch(`/system-admin/users/api/users?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            renderUsersTable(data.users);
            updatePagination(data);
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

// Render users table
function renderUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No users found</td></tr>';
        return;
    }
    
    tbody.innerHTML = users.map(user => {
        const statusBadge = user.is_active 
            ? '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Active</span>'
            : '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Inactive</span>';
        
        const roleBadges = {
            'system_administrator': 'bg-purple-100 text-purple-800',
            'admin': 'bg-blue-100 text-blue-800',
            'manager': 'bg-green-100 text-green-800',
            'employee': 'bg-gray-100 text-gray-800'
        };
        
        const roleClass = roleBadges[user.role] || roleBadges.employee;
        
        return `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">${user.full_name ? user.full_name.charAt(0).toUpperCase() : 'U'}</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${user.full_name || 'N/A'}</p>
                            <p class="text-sm text-gray-500">${user.business ? user.business.name : 'No Business'}</p>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-6">
                    <div>
                        <p class="font-medium text-gray-900">${user.email}</p>
                        <p class="text-sm text-gray-500">@${user.username}</p>
                    </div>
                </td>
                <td class="py-3 px-6">
                    <span class="px-2 py-1 text-xs font-medium ${roleClass} rounded-full">${user.role}</span>
                </td>
                <td class="py-3 px-6">${statusBadge}</td>
                <td class="py-3 px-6">
                    <span class="text-sm text-gray-600">${user.permissions ? user.permissions.join(', ') : 'System Dashboard, User Management, Business Management, System Settings, System Analytics, Monitoring, Reports'}</span>
                </td>
                <td class="py-3 px-6">
                    <div class="flex space-x-2">
                        ${user.username === 'MM001' ? 
                            `<span class="text-gray-400 text-sm font-medium px-2 py-1 rounded bg-gray-50">
                                <i class="fas fa-lock mr-1"></i>Protected Account
                            </span>` :
                            `<button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-2 py-1 rounded hover:bg-blue-50 transition-colors">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="deleteUser('${user.id}', '${user.username}')" class="text-red-600 hover:text-red-800 text-sm font-medium px-2 py-1 rounded hover:bg-red-50 transition-colors">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>`
                        }
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('userCount').textContent = users.length;
}

// Update pagination
function updatePagination(data) {
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= (data.pages || 1);
    
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            loadUsers(currentPage, currentSearch, currentRole, currentStatus);
        }
    };
    
    nextBtn.onclick = () => {
        if (currentPage < (data.pages || 1)) {
            currentPage++;
            loadUsers(currentPage, currentSearch, currentRole, currentStatus);
        }
    };
}

// Reset filters
function resetFilters() {
    document.getElementById('roleFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('userSearch').value = '';
    currentPage = 1;
    currentSearch = '';
    currentRole = '';
    currentStatus = '';
    loadUsers();
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadUserStats();
    loadUsers();
    
    // Auto-generate username preview when name fields change
    const firstNameField = document.getElementById('firstName');
    const lastNameField = document.getElementById('lastName');
    const usernameField = document.getElementById('username');
    
    function updateUsernamePreview() {
        const firstName = firstNameField.value.trim();
        const lastName = lastNameField.value.trim();
        
        // Update username preview only
        if (usernameField) {
            if (firstName && lastName) {
                const firstChar = firstName.charAt(0).toUpperCase();
                const lastChar = lastName.charAt(0).toUpperCase();
                usernameField.value = `${firstChar}${lastChar}# (Auto-generated)`;
                usernameField.placeholder = `Will be: ${firstChar}${lastChar}1, ${firstChar}${lastChar}2, etc.`;
            } else {
                usernameField.value = '';
                usernameField.placeholder = 'Auto-generated from name';
            }
        }
    }
    
    if (firstNameField && lastNameField && usernameField) {
        firstNameField.addEventListener('input', updateUsernamePreview);
        lastNameField.addEventListener('input', updateUsernamePreview);
    }
    
    // Add event listeners
    document.getElementById('userSearch').addEventListener('input', function(e) {
        currentSearch = e.target.value;
        currentPage = 1;
        setTimeout(() => {
            loadUsers(currentPage, currentSearch, currentRole, currentStatus);
        }, 500);
    });
    
    document.getElementById('roleFilter').addEventListener('change', function(e) {
        currentRole = e.target.value;
        currentPage = 1;
        loadUsers(currentPage, currentSearch, currentRole, currentStatus);
    });
    
    document.getElementById('statusFilter').addEventListener('change', function(e) {
        currentStatus = e.target.value;
        currentPage = 1;
        loadUsers(currentPage, currentSearch, currentRole, currentStatus);
    });
    
    // Add User Form Event Listener
    document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
    
    // Edit User Form Event Listener
    document.getElementById('editUserForm').addEventListener('submit', handleEditUser);
    
    // Password strength checker
    document.getElementById('password').addEventListener('input', checkPasswordStrength);
});

// Modal Functions
function openAddUserModal() {
    document.getElementById('addUserModal').classList.remove('hidden');
    // Reset form
    document.getElementById('addUserForm').reset();
    document.getElementById('passwordStrength').innerHTML = '';
    
    // Reset permissions to all checked (default for system admin)
    selectAllPermissions();
}

function closeAddUserModal() {
    document.getElementById('addUserModal').classList.add('hidden');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('addUserModal');
    if (event.target === modal) {
        closeAddUserModal();
    }
});

// Toggle password visibility
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById('passwordToggleIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Permission management functions
function selectAllPermissions() {
    const checkboxes = document.querySelectorAll('input[name="permissions"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function clearAllPermissions() {
    const checkboxes = document.querySelectorAll('input[name="permissions"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

// Edit Permission management functions
function selectAllEditPermissions() {
    const checkboxes = document.querySelectorAll('input[name="edit_permissions"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function clearAllEditPermissions() {
    const checkboxes = document.querySelectorAll('input[name="edit_permissions"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

// Password strength checker
function checkPasswordStrength() {
    const password = document.getElementById('password').value;
    const strengthDiv = document.getElementById('passwordStrength');
    
    if (!password) {
        strengthDiv.innerHTML = '';
        return;
    }
    
    let score = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) score++;
    else feedback.push('At least 8 characters');
    
    // Uppercase check
    if (/[A-Z]/.test(password)) score++;
    else feedback.push('One uppercase letter');
    
    // Lowercase check
    if (/[a-z]/.test(password)) score++;
    else feedback.push('One lowercase letter');
    
    // Number check
    if (/\d/.test(password)) score++;
    else feedback.push('One number');
    
    // Special character check
    if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\?]/.test(password)) score++;
    else feedback.push('One special character');
    
    let strength = '';
    let color = '';
    
    if (score < 2) {
        strength = 'Very Weak';
        color = 'text-red-600';
    } else if (score < 3) {
        strength = 'Weak';
        color = 'text-orange-600';
    } else if (score < 4) {
        strength = 'Medium';
        color = 'text-yellow-600';
    } else if (score < 5) {
        strength = 'Strong';
        color = 'text-blue-600';
    } else {
        strength = 'Very Strong';
        color = 'text-green-600';
    }
    
    let html = `<span class="${color} font-medium">Password Strength: ${strength}</span>`;
    if (feedback.length > 0) {
        html += `<br><span class="text-gray-600">Missing: ${feedback.join(', ')}</span>`;
    }
    
    strengthDiv.innerHTML = html;
}

// Handle Add User Form Submission
async function handleAddUser(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    // Get selected permissions
    const selectedPermissions = [];
    const permissionCheckboxes = document.querySelectorAll('input[name="permissions"]:checked');
    permissionCheckboxes.forEach(checkbox => {
        selectedPermissions.push(checkbox.value);
    });
    
    const userData = {
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        full_name: formData.get('full_name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        role: formData.get('role'),
        designation: formData.get('designation'),
        department: formData.get('department'),
        address: formData.get('address'),
        password: formData.get('password'),
        is_active: formData.get('is_active') === 'on',
        is_protected: formData.get('is_protected') === 'on',
        requires_password_change: formData.get('requires_password_change') === 'on',
        permissions: selectedPermissions
    };
    
    try {
        const response = await fetch('/system-admin/users/api/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        });
        
        let result;
        try {
            result = await response.json();
        } catch (jsonError) {
            console.error('Failed to parse response JSON:', jsonError);
            showNotification('Server response error. Please try again.', 'error');
            return;
        }
        
        if (response.ok) {
            // Success
            showNotification('System administrator created successfully!', 'success');
            closeAddUserModal();
            loadUsers(); // Refresh the user list
            loadUserStats(); // Refresh statistics
        } else {
            // Error from server
            console.error('Server error:', result);
            const errorMessage = result.error || 'Failed to create system administrator';
            showNotification(errorMessage, 'error');
            // Fallback alert in case notification system fails
            if (!document.getElementById('notificationContainer')) {
                alert('Error: ' + errorMessage);
            }
        }
    } catch (error) {
        console.error('Network error creating user:', error);
        console.error('User data being sent:', userData);
        showNotification('Network error occurred. Please try again.', 'error');
    }
}

// Enhanced notification system with luxury animations
function showNotification(message, type = 'info', duration = 5000) {
    let notificationContainer = document.getElementById('notificationContainer');
    
    // Create container if it doesn't exist
    if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notificationContainer';
        notificationContainer.className = 'fixed top-4 right-4 z-50 space-y-3 max-w-sm';
        document.body.appendChild(notificationContainer);
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification p-5 text-white font-medium flex items-start justify-between min-w-80 max-w-sm`;
    
    // Add type-specific styling
    const typeClasses = {
        'success': 'notification-success',
        'error': 'notification-error', 
        'warning': 'notification-warning',
        'info': 'notification-info'
    };
    notification.classList.add(typeClasses[type] || typeClasses['info']);
    
    // Add icon and title based on type
    const notificationData = {
        'success': { icon: 'fas fa-check-circle', title: 'Success' },
        'error': { icon: 'fas fa-exclamation-circle', title: 'Error' },
        'warning': { icon: 'fas fa-exclamation-triangle', title: 'Warning' },
        'info': { icon: 'fas fa-info-circle', title: 'Information' }
    };
    
    const data = notificationData[type] || notificationData['info'];
    
    notification.innerHTML = `
        <div class="flex items-start flex-1">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                <i class="${data.icon} text-lg"></i>
            </div>
            <div class="flex-1">
                <div class="font-semibold text-sm mb-1">${data.title}</div>
                <div class="text-sm text-white/90 leading-relaxed">${message}</div>
            </div>
        </div>
        <button onclick="removeNotification(this.parentElement)" class="ml-3 w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110 flex-shrink-0">
            <i class="fas fa-times text-sm"></i>
        </button>
    `;
    
    // Add to container
    notificationContainer.appendChild(notification);
    
    // Animate in with stagger effect
    setTimeout(() => notification.classList.add('show'), 100);
    
    // Auto remove with enhanced animation
    setTimeout(() => {
        removeNotification(notification);
    }, duration);
}

// Enhanced notification removal
function removeNotification(notification) {
    if (notification && notification.parentElement) {
        notification.classList.add('hide');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 400);
    }
}

// Custom Confirmation Modal System
function showConfirmationModal(title, message, onConfirm, confirmText = 'Confirm') {
    const modal = document.getElementById('confirmationModal');
    const titleElement = document.getElementById('confirmTitle');
    const messageElement = document.getElementById('confirmMessage');
    const confirmButton = document.getElementById('confirmButton');
    
    // Check if elements exist
    if (!modal || !titleElement || !messageElement || !confirmButton) {
        console.error('Confirmation modal elements not found');
        // Fallback to browser confirm if modal elements are missing
        if (confirm(`${title}\n\n${message}`)) {
            onConfirm();
        }
        return;
    }
    
    // Set content
    titleElement.textContent = title;
    messageElement.textContent = message;
    confirmButton.innerHTML = `<i class="fas fa-trash mr-2"></i>${confirmText}`;
    
    // Set up confirm action
    confirmButton.onclick = () => {
        onConfirm();
        closeConfirmationModal();
    };
    
    // Show modal with animation
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('confirmationModal');
    if (modal && event.target === modal) {
        closeConfirmationModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('confirmationModal');
        if (modal && modal.classList.contains('show')) {
            closeConfirmationModal();
        }
    }
});

// Edit User Function
async function editUser(userId) {
    try {
        // Fetch user data
        const response = await fetch(`/system-admin/users/api/user/${userId}`);
        const result = await response.json();
        
        if (response.ok) {
            const user = result.user;
            
            // Populate edit form
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editFirstName').value = user.first_name || '';
            document.getElementById('editLastName').value = user.last_name || '';
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editPhone').value = user.phone || '';
            document.getElementById('editFullName').value = user.full_name || '';
            document.getElementById('editRole').value = user.role || '';
            document.getElementById('editDesignation').value = user.designation || '';
            document.getElementById('editDepartment').value = user.department || '';
            document.getElementById('editAddress').value = user.address || '';
            document.getElementById('editIsActive').checked = user.is_active;
            document.getElementById('editIsProtected').checked = user.is_protected;
            
            // Populate permissions
            const userPermissions = user.permissions || [];
            const editPermissionCheckboxes = document.querySelectorAll('input[name="edit_permissions"]');
            editPermissionCheckboxes.forEach(checkbox => {
                checkbox.checked = userPermissions.includes(checkbox.value);
            });
            
            // Show edit modal
            openEditUserModal();
        } else {
            showNotification(result.error || 'Failed to load user data', 'error');
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        showNotification('Network error occurred. Please try again.', 'error');
    }
}

// Edit User Modal Functions
function openEditUserModal() {
    document.getElementById('editUserModal').classList.remove('hidden');
}

function closeEditUserModal() {
    document.getElementById('editUserModal').classList.add('hidden');
}

// Close edit modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('editUserModal');
    if (event.target === modal) {
        closeEditUserModal();
    }
});

// Handle Edit User Form Submission
async function handleEditUser(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const userId = formData.get('user_id');
    
    // Get selected permissions
    const selectedEditPermissions = [];
    const editPermissionCheckboxes = document.querySelectorAll('input[name="edit_permissions"]:checked');
    editPermissionCheckboxes.forEach(checkbox => {
        selectedEditPermissions.push(checkbox.value);
    });
    
    const userData = {
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        full_name: formData.get('full_name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        role: formData.get('role'),
        designation: formData.get('designation'),
        department: formData.get('department'),
        address: formData.get('address'),
        is_active: formData.get('is_active') === 'on',
        is_protected: formData.get('is_protected') === 'on',
        permissions: selectedEditPermissions
    };
    
    try {
        const response = await fetch(`/system-admin/users/api/update/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification('System administrator updated successfully!', 'success');
            closeEditUserModal();
            loadUsers(); // Refresh the user list
            loadUserStats(); // Refresh statistics
        } else {
            showNotification(result.error || 'Failed to update system administrator', 'error');
        }
    } catch (error) {
        console.error('Error updating user:', error);
        console.error('User data being sent:', userData);
        showNotification('Network error occurred. Please try again.', 'error');
    }
}

// Delete User Function with Custom Confirmation
function deleteUser(userId, username) {
    if (username === 'MM001') {
        showNotification('Cannot delete the main system administrator account (MM001)', 'error');
        return;
    }
    
    showConfirmationModal(
        'Delete User Account',
        `Are you sure you want to delete user "${username}"? This action cannot be undone and will permanently remove all user data.`,
        () => deleteUserAPI(userId, username),
        'Delete User'
    );
}

// Delete User API Call
async function deleteUserAPI(userId, username) {
    try {
        const response = await fetch(`/system-admin/users/api/delete/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(`User "${username}" deleted successfully`, 'success');
            loadUsers(); // Refresh the user list
            loadUserStats(); // Refresh statistics
        } else {
            showNotification(result.error || 'Failed to delete user', 'error');
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        showNotification('Network error occurred. Please try again.', 'error');
    }
}
</script>
{% endblock %}
