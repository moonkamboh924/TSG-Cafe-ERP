{% extends "base.html" %}

{% block title %}Invoice {{ invoice.invoice_number }} - Billing{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-6 no-print">
            <button onclick="window.location.href='{{ url_for('billing.index') }}'" class="inline-flex items-center text-sm font-medium text-gray-600 hover:text-gray-900 transition mb-4">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Billing
            </button>
            
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Invoice Details</h1>
                    <p class="text-gray-600 mt-1">{{ invoice.invoice_number }}</p>
                </div>
                
                <button onclick="window.print()" class="bg-indigo-600 px-4 py-2 rounded-lg text-sm font-medium text-white hover:bg-indigo-700 transition flex items-center gap-2 shadow-sm">
                    <i class="fas fa-print"></i>
                    Print Invoice
                </button>
            </div>
        </div>

        <!-- Invoice Card -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
            <!-- Status Banner -->
            <div class="{% if invoice.payment_method == 'trial' %}bg-gradient-to-r from-purple-500 to-blue-500{% elif invoice.status == 'paid' %}bg-gradient-to-r from-green-500 to-emerald-500{% elif invoice.status == 'pending' %}bg-gradient-to-r from-yellow-500 to-orange-500{% else %}bg-gradient-to-r from-red-500 to-pink-500{% endif %} px-6 py-3">
                <div class="flex items-center justify-between text-white">
                    <div class="flex items-center gap-2">
                        {% if invoice.payment_method == 'trial' %}
                        <i class="fas fa-gift text-xl"></i>
                        <div>
                            <p class="text-xs font-medium opacity-90">Trial Period Invoice</p>
                            <p class="text-base font-bold">Free Trial - No Payment Required</p>
                        </div>
                        {% elif invoice.status == 'paid' %}
                        <i class="fas fa-check-circle text-xl"></i>
                        <div>
                            <p class="text-xs font-medium opacity-90">Payment Status</p>
                            <p class="text-base font-bold">Paid</p>
                        </div>
                        {% elif invoice.status == 'pending' %}
                        <i class="fas fa-clock text-xl"></i>
                        <div>
                            <p class="text-xs font-medium opacity-90">Payment Status</p>
                            <p class="text-base font-bold">Pending Payment</p>
                        </div>
                        {% else %}
                        <i class="fas fa-exclamation-circle text-xl"></i>
                        <div>
                            <p class="text-xs font-medium opacity-90">Payment Status</p>
                            <p class="text-base font-bold">{{ invoice.status|capitalize }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if invoice.paid_at %}
                    <div class="text-right">
                        <p class="text-xs opacity-90">Paid on</p>
                        <p class="text-sm font-bold">{{ invoice.paid_at.strftime('%B %d, %Y') }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Invoice Header -->
            <div class="px-6 py-3 border-b border-gray-200">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Business Info -->
                    <div>
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">From</h3>
                        <div class="text-gray-900">
                            <p class="text-base font-bold">{{ business.business_name }}</p>
                            {% if business.address %}
                            <p class="text-xs text-gray-600 mt-1">{{ business.address }}</p>
                            {% endif %}
                            {% if business.phone %}
                            <p class="text-xs text-gray-600">{{ business.phone }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Invoice Details -->
                    <div class="text-right">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Invoice Details</h3>
                        <div class="space-y-1">
                            <div>
                                <p class="text-xs text-gray-500">Invoice Number</p>
                                <p class="text-sm font-semibold text-gray-900">{{ invoice.invoice_number }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Invoice Date</p>
                                <p class="text-sm font-semibold text-gray-900">{{ invoice.created_at.strftime('%B %d, %Y') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Billing Period -->
            <div class="px-6 py-2 bg-gradient-to-r from-gray-50 to-blue-50 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-600">Billing Period</p>
                        <p class="text-sm font-semibold text-gray-900">
                            {{ invoice.billing_period_start.strftime('%B %d, %Y') }} - {{ invoice.billing_period_end.strftime('%B %d, %Y') }}
                        </p>
                    </div>
                    {% if invoice.payment_method == 'trial' %}
                    <div class="bg-gradient-to-r from-purple-100 to-blue-100 px-3 py-1 rounded-lg border border-purple-200">
                        <p class="text-xs font-semibold text-purple-700">
                            <i class="fas fa-gift mr-1"></i>
                            {% set trial_days = (invoice.billing_period_end - invoice.billing_period_start).days %}
                            {{ trial_days }}-Day Free Trial
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Invoice Items -->
            <div class="px-6 py-4">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-2 text-xs font-semibold text-gray-600 uppercase tracking-wide">Description</th>
                            <th class="text-right py-2 text-xs font-semibold text-gray-600 uppercase tracking-wide">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-gray-100">
                            <td class="py-3">
                                <p class="font-medium text-gray-900 text-sm">
                                    {% if invoice.payment_method == 'trial' %}
                                    Trial Period Subscription
                                    {% else %}
                                    Subscription Plan
                                    {% endif %}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">{{ business.get_plan_name() }} Plan</p>
                            </td>
                            <td class="text-right py-3">
                                <span class="font-semibold text-gray-900 text-sm">
                                    {{ invoice.currency }} ${{ "%.2f"|format(invoice.amount) }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Totals -->
                <div class="mt-4 space-y-1">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-medium text-gray-900">{{ invoice.currency }} ${{ "%.2f"|format(invoice.amount) }}</span>
                    </div>
                    
                    {% if invoice.tax_amount > 0 %}
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Tax</span>
                        <span class="font-medium text-gray-900">{{ invoice.currency }} ${{ "%.2f"|format(invoice.tax_amount) }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="border-t-2 border-gray-200 pt-2 mt-2">
                        <div class="flex justify-between">
                            <span class="text-base font-semibold text-gray-900">Total</span>
                            <span class="text-xl font-bold {% if invoice.payment_method == 'trial' %}text-purple-600{% else %}text-gray-900{% endif %}">
                                {{ invoice.currency }} ${{ "%.2f"|format(invoice.total_amount) }}
                            </span>
                        </div>
                        {% if invoice.payment_method == 'trial' %}
                        <p class="text-right text-xs text-purple-600 mt-1">
                            <i class="fas fa-gift mr-1"></i>
                            Free Trial - No Charge
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Payment Information -->
            {% if invoice.status == 'paid' and invoice.payment_method %}
            <div class="px-6 py-3 bg-gradient-to-r from-green-50 to-emerald-50 border-t border-gray-200">
                <h3 class="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-2">Payment Information</h3>
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div>
                        <p class="text-gray-600">Payment Method</p>
                        <p class="font-semibold text-gray-900 capitalize">
                            {% if invoice.payment_method == 'trial' %}
                            <i class="fas fa-gift mr-1 text-purple-600"></i>
                            Trial Period (Free)
                            {% else %}
                            {{ invoice.payment_method }}
                            {% endif %}
                        </p>
                    </div>
                    {% if invoice.transaction_id %}
                    <div>
                        <p class="text-gray-600">Transaction ID</p>
                        <p class="font-mono text-xs font-semibold text-gray-900">{{ invoice.transaction_id }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Footer Note -->
            <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
                <div class="text-center text-xs text-gray-600">
                    <p class="font-medium">Thank you for your business!</p>
                    {% if invoice.payment_method == 'trial' %}
                    <p class="mt-1 text-purple-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Your trial period will end on {{ invoice.billing_period_end.strftime('%B %d, %Y') }}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    body * {
        visibility: hidden;
    }
    .bg-white.rounded-2xl, .bg-white.rounded-2xl * {
        visibility: visible;
    }
    .bg-white.rounded-2xl {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        box-shadow: none;
        border-radius: 0;
    }
    button, .no-print {
        display: none !important;
    }
    
    /* Ensure single page */
    @page {
        size: A4;
        margin: 10mm;
    }
    
    /* Force single page */
    html, body {
        height: 100%;
        overflow: hidden;
    }
    
    .bg-white.rounded-2xl {
        max-height: 100vh;
        overflow: hidden;
    }
    
    /* Prevent page breaks */
    * {
        page-break-inside: avoid !important;
        page-break-before: avoid !important;
        page-break-after: avoid !important;
    }
}
</style>
{% endblock %}
